<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Nether S.A.C. — Base de Datos</title>

  <!-- NO CACHE -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">

  <!-- Google Icons (Material Symbols) -->
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" rel="stylesheet" />
  <style>
    .material-symbols-outlined {
      font-variation-settings:
        'FILL' 0,
        'wght' 400,
        'GRAD' 0,
        'opsz' 24;
      font-size: 1.25em;
      line-height: 1;
      vertical-align: -2px;
    }
  </style>

  <!-- Fuente base -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />

  <style>
    :root{
      --font-family-base:"Arial-BoldMT", Inter, Arial, Helvetica, sans-serif;
      --font-size-base:13px;         /* Tamaño único en toda la app */
      --strip-height:22px;
      --strip-speed:26s;
      --brand:#0000ee;
      --border:#c6c6c6;
      --bg:#ffffff;
      --accent:#1e40af;
      --accent-2:#eef2ff;
      --danger:#c53030;
      --muted:#777;
      --ok:#0d8a4e;
    }

    html,body{height:100%;margin:0}
    body{
      font-family:var(--font-family-base);
      font-size:var(--font-size-base);
      background:var(--bg);
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
      display:flex; flex-direction:column; min-height:100vh;
    }

    /* Ticker superior */
    .moving-strip{
      width:100%;height:var(--strip-height);
      background:linear-gradient(to bottom,#e9e9e98c 0%,#ffffff 100%);
      overflow:hidden;position:relative; flex:0 0 auto;
    }
    .scroll-text{
      position:absolute;top:0;left:0;white-space:nowrap;display:inline-block;
      padding:0 .75rem;color:var(--brand);line-height:var(--strip-height);
      will-change:transform;visibility:hidden;transform:translateX(var(--start,0px));
      animation:marqueePx var(--strip-speed) linear infinite;
    }
    @keyframes marqueePx{from{transform:translateX(var(--start));}to{transform:translateX(var(--end));}}

    /* ====== Layout: UNA SOLA CAJA ====== */
    .wrap{max-width:1200px;margin:12px auto;padding:0 12px; width:100%; flex:1 0 auto;}
    .app{border:1px solid var(--border);border-radius:12px;background:#fff;padding:14px; box-shadow:0 2px 10px rgba(0,0,0,.04)}

    /* Topbar */
    .topbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .search{flex:1;display:flex;align-items:center;gap:6px;border:1px solid var(--border);border-radius:8px;padding:6px 8px}
    .search input{border:none;outline:none;flex:1;font:inherit}

    /* Botones de formulario (solo nombres) */
    .btn{border:1px solid var(--border);border-radius:8px;background:#f7f8ff;padding:6px 10px;cursor:pointer;font:inherit;display:inline-flex;align-items:center;gap:6px}
    .btn:hover{background:#eef2ff}
    .btn.primary{background:var(--accent-2);border-color:#c3d0ff}
    .btn.danger{background:#fff0f0;border-color:#f3c7c7}
    .btn.ghost{background:#fff}

    /* Tabs */
    .tabs{display:flex;gap:6px;flex-wrap:wrap}
    .tab{border:1px solid var(--border);border-radius:999px;padding:6px 10px;cursor:pointer;background:#f8f8f8;font:inherit}
    .tab.active{background:var(--accent-2);border-color:#c3d0ff;color:#223}

    /* Formularios / campos */
    .grid{display:grid;gap:8px}
    .cols-2{grid-template-columns:1fr 1fr}
    .cols-3{grid-template-columns:repeat(3,1fr)}
    @media(max-width:820px){ .cols-2,.cols-3{grid-template-columns:1fr} }

    label{font-weight:700;font-size:var(--font-size-base)}
    .field{display:flex;flex-direction:column;gap:4px}
    .field input,.field select,.field textarea{
      border:1px solid var(--border); border-radius:6px; padding:6px; font:inherit;
    }
    .section{margin-top:10px}
    h1,h2,h3,h4,h5,h6{margin:0 0 6px;font-size:var(--font-size-base);font-weight:700} /* mismo tamaño */
    .muted{color:var(--muted)}
    .status{font-size:var(--font-size-base);color:var(--muted)}
    .ok{color:var(--ok)}
    .error{color:var(--danger)}

    /* Tabla */
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid #ececec;padding:6px 8px;text-align:left}
    th{background:#f7f7f7}
    .row-actions{display:flex;gap:6px}
    .empty{color:var(--muted);font-style:italic}

    /* Auth box */
    .auth{max-width:520px;margin:16px auto;padding:16px;border:1px solid var(--border);border-radius:8px;background:#fff}
    .auth .hint{color:var(--muted)}

    /* Footer */
    footer{ text-align:center; color:#808080; padding:10px 0 16px; flex:0 0 auto;}
  </style>
</head>
<body>
  <!-- Ticker -->
  <div class="moving-strip">
    <span class="scroll-text" id="ticker">Nether S.A.C. — Base de datos interna • Personal | Bienes | Servicios • Acceso privado</span>
  </div>

  <div class="wrap">
    <div class="app">
      <!-- TOP -->
      <div class="topbar">
        <div class="search" style="flex:1">
          <span class="material-symbols-outlined">search</span>
          <input id="q" type="search" placeholder="Buscar por nombre, DNI, RUC, celular, empresa, etc."/>
        </div>

        <div class="tabs">
          <button class="tab active" data-tab="todo">Todo</button>
          <button class="tab" data-tab="personas">Personal</button>
          <button class="tab" data-tab="bienes">Bienes</button>
          <button class="tab" data-tab="servicios">Servicios</button>
        </div>

        <button class="btn ghost" id="btnExport"><span class="material-symbols-outlined">file_export</span> Exportar CSV</button>
        <span id="conn" class="status">—</span>
      </div>

      <!-- ACCESO -->
      <div id="authBox" class="auth" style="display:none">
        <h3>Acceso privado — Nether S.A.C.</h3>
        <div class="grid cols-2">
          <div class="field"><label>Correo</label><input id="auth-email" type="email" placeholder="tu@empresa.com"/></div>
          <div class="field"><label>Contraseña</label><input id="auth-pass" type="password" placeholder="••••••••"/></div>
        </div>
        <div class="grid cols-2" style="margin-top:8px">
          <button class="btn primary" id="btnLogin"><span class="material-symbols-outlined">login</span> Ingresar</button>
          <button class="btn" id="btnSignup"><span class="material-symbols-outlined">person_add</span> Crear usuario</button>
        </div>
        <div id="auth-msg" class="status" style="margin-top:6px"></div>
        <div class="hint" style="margin-top:6px">Nota: el registro y acceso usan Supabase Auth (gratuito).</div>
      </div>

      <!-- APP -->
      <div id="appBox" style="display:none">
        <!-- BOTONES (solo nombres) -->
        <div class="section" style="display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn primary" id="btnPersonal"><span class="material-symbols-outlined">person</span> Personal</button>
          <button class="btn primary" id="btnBienes"><span class="material-symbols-outlined">inventory_2</span> Bienes</button>
          <button class="btn primary" id="btnServicios"><span class="material-symbols-outlined">home_repair_service</span> Servicios</button>
          <button class="btn danger" id="btnSignOut" style="margin-left:auto"><span class="material-symbols-outlined">logout</span> Cerrar sesión</button>
        </div>

        <!-- FORMULARIOS (aparecen en la misma cajita) -->
        <div class="section" id="sec-persona" style="display:none">
          <h3>Personal</h3>
          <div class="grid cols-3">
            <div class="field"><label>Nombres completos</label><input id="p-nombres" /></div>
            <div class="field"><label>DNI</label><input id="p-dni" /></div>
            <div class="field"><label>Celular</label><input id="p-celular" /></div>
            <div class="field"><label>RUC</label><input id="p-ruc" /></div>
            <div class="field"><label>Dirección</label><input id="p-direccion" /></div>
            <div class="field"><label>N° Cuenta</label><input id="p-cuenta" /></div>
            <div class="field"><label>Banco</label><input id="p-banco" /></div>
          </div>
          <div style="margin-top:8px">
            <button class="btn primary" id="save-persona"><span class="material-symbols-outlined">save</span> Guardar</button>
            <span id="msg-persona" class="status"></span>
          </div>
        </div>

        <div class="section" id="sec-bien" style="display:none">
          <h3>Bienes</h3>
          <div class="grid cols-3">
            <div class="field"><label>Nombre del proveedor</label><input id="b-nombre" /></div>
            <div class="field"><label>Empresa</label><input id="b-empresa" /></div>
            <div class="field"><label>RUC</label><input id="b-ruc" /></div>
            <div class="field"><label>Celular</label><input id="b-celular" /></div>
            <div class="field"><label>¿Qué provee?</label><input id="b-provee" /></div>
          </div>
          <div style="margin-top:8px">
            <button class="btn primary" id="save-bien"><span class="material-symbols-outlined">save</span> Guardar</button>
            <span id="msg-bien" class="status"></span>
          </div>
        </div>

        <div class="section" id="sec-serv" style="display:none">
          <h3>Servicios</h3>
          <div class="grid cols-3">
            <div class="field"><label>Nombre del proveedor</label><input id="s-nombre" /></div>
            <div class="field"><label>Empresa</label><input id="s-empresa" /></div>
            <div class="field"><label>RUC</label><input id="s-ruc" /></div>
            <div class="field"><label>Celular</label><input id="s-celular" /></div>
            <div class="field"><label>Servicio que brinda</label><input id="s-servicio" /></div>
          </div>
          <div style="margin-top:8px">
            <button class="btn primary" id="save-serv"><span class="material-symbols-outlined">save</span> Guardar</button>
            <span id="msg-serv" class="status"></span>
          </div>
        </div>

        <!-- LISTADOS -->
        <div class="section">
          <h3 id="list-title">Resultados</h3>
          <div id="lists">
            <div class="section" id="list-personas"></div>
            <div class="section" id="list-bienes"></div>
            <div class="section" id="list-servicios"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <footer>© Nether S.A.C. — Base de datos interna.</footer>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    /* ======= CONFIG =======
       Reemplaza con tus valores de Supabase (Proyecto → Settings → API) */
    const SUPABASE_URL = "https://jvmecjufprxspcltwimm.supabase.co";   // <<— URL de tu proyecto
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp2bWVjanVmcHJ4c3BjbHR3aW1tIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA2NzI0NTcsImV4cCI6MjA3NjI0ODQ1N30.nC7cax8JTH9EVyTHpD32ObCxsPgfyRBucz6wbAGviL0";                         // <<— anon key (pública)

    // Tablas
    const T_PERSONAS  = "personas";
    const T_BIENES    = "proveedores_bienes";
    const T_SERVICIOS = "proveedores_servicios";

    // Estado
    let activeTab = "todo";
    let searchTerm = "";
    let user = null;
    let cache = { personas: [], bienes: [], servicios: [] };

    // Supabase client
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ===== Helpers =====
    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

    function setConnStatus(ok){
      const el = $("#conn");
      if(!el) return;
      el.textContent = ok ? "Conectado" : "Sin conexión";
      el.className = "status " + (ok ? "ok" : "error");
    }

    // ===== Ticker =====
    (function initTicker(){
      const el = document.getElementById('ticker');
      function recalc(){
        const wrapW = el.parentElement.clientWidth;
        const textW = el.getBoundingClientRect().width;
        el.style.setProperty('--start', wrapW + 'px');
        el.style.setProperty('--end', -textW + 'px');
        el.style.visibility = 'visible';
      }
      setTimeout(recalc, 100); // después de cargar fuentes
      window.addEventListener('resize', recalc);
    })();

    // ===== Auth & App init =====
    async function init(){
      setConnStatus(!!SUPABASE_URL && !!SUPABASE_ANON_KEY);

      const { data } = await supabase.auth.getUser();
      user = data?.user || null;
      toggleApp(!!user);

      if(user){
        await fetchAll();
        render();
      }
    }

    function toggleApp(showApp){
      $("#authBox").style.display = showApp ? "none" : "block";
      $("#appBox").style.display  = showApp ? "block" : "none";
    }

    // Login
    $("#btnLogin").addEventListener("click", async () => {
      const email = $("#auth-email").value.trim();
      const pass  = $("#auth-pass").value.trim();
      $("#auth-msg").textContent = "Ingresando...";
      const { data, error } = await supabase.auth.signInWithPassword({ email, password: pass });
      if(error){ $("#auth-msg").textContent = "Error: " + error.message; return; }
      user = data.user;
      $("#auth-msg").textContent = "Listo.";
      toggleApp(true);
      await fetchAll();
      render();
    });

    // Signup
    $("#btnSignup").addEventListener("click", async () => {
      const email = $("#auth-email").value.trim();
      const pass  = $("#auth-pass").value.trim();
      $("#auth-msg").textContent = "Creando usuario...";
      const { data, error } = await supabase.auth.signUp({ email, password: pass });
      if(error){ $("#auth-msg").textContent = "Error: " + error.message; return; }
      $("#auth-msg").textContent = "Usuario creado. Revisa tu correo si te piden confirmación.";
    });

    // SignOut
    $("#btnSignOut").addEventListener("click", async () => {
      await supabase.auth.signOut();
      user = null;
      toggleApp(false);
      $("#auth-msg").textContent = "Sesión cerrada.";
    });

    // ===== Tabs (Todo / Personas / Bienes / Servicios) =====
    $$(".tab").forEach(btn => {
      btn.addEventListener("click", () => {
        $$(".tab").forEach(x=>x.classList.remove("active"));
        btn.classList.add("active");
        activeTab = btn.getAttribute("data-tab");
        render();
      });
    });

    // ===== Botones para mostrar formularios =====
    $("#btnPersonal").addEventListener("click", () => showForm("persona"));
    $("#btnBienes").addEventListener("click", () => showForm("bien"));
    $("#btnServicios").addEventListener("click", () => showForm("serv"));

    function showForm(which){
      $("#sec-persona").style.display = which==="persona" ? "block" : "none";
      $("#sec-bien").style.display    = which==="bien"    ? "block" : "none";
      $("#sec-serv").style.display    = which==="serv"    ? "block" : "none";
      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    // ===== Guardar registros =====
    $("#save-persona").addEventListener("click", async () => {
      const payload = {
        nombres: $("#p-nombres").value.trim(),
        dni: $("#p-dni").value.trim(),
        celular: $("#p-celular").value.trim(),
        ruc: $("#p-ruc").value.trim(),
        direccion: $("#p-direccion").value.trim(),
        cuenta: $("#p-cuenta").value.trim(),
        banco: $("#p-banco").value.trim(),
        user_id: user?.id || null,
      };
      $("#msg-persona").textContent = "Guardando...";
      const { error } = await supabase.from(T_PERSONAS).insert(payload);
      if(error){ $("#msg-persona").textContent = "Error: "+error.message; return; }
      $("#msg-persona").textContent = "Guardado.";
      Object.keys(payload).forEach(k=>{ const el = document.getElementById("p-"+k); if(el) el.value = ""; });
      await fetchAll(); render();
    });

    $("#save-bien").addEventListener("click", async () => {
      const payload = {
        nombre: $("#b-nombre").value.trim(),
        empresa: $("#b-empresa").value.trim(),
        ruc: $("#b-ruc").value.trim(),
        celular: $("#b-celular").value.trim(),
        provee: $("#b-provee").value.trim(),
        user_id: user?.id || null,
      };
      $("#msg-bien").textContent = "Guardando...";
      const { error } = await supabase.from(T_BIENES).insert(payload);
      if(error){ $("#msg-bien").textContent = "Error: "+error.message; return; }
      $("#msg-bien").textContent = "Guardado.";
      await fetchAll(); render();
    });

    $("#save-serv").addEventListener("click", async () => {
      const payload = {
        nombre: $("#s-nombre").value.trim(),
        empresa: $("#s-empresa").value.trim(),
        ruc: $("#s-ruc").value.trim(),
        celular: $("#s-celular").value.trim(),
        servicio: $("#s-servicio").value.trim(),
        user_id: user?.id || null,
      };
      $("#msg-serv").textContent = "Guardando...";
      const { error } = await supabase.from(T_SERVICIOS).insert(payload);
      if(error){ $("#msg-serv").textContent = "Error: "+error.message; return; }
      $("#msg-serv").textContent = "Guardado.";
      await fetchAll(); render();
    });

    // ===== Fetch & Render =====
    async function fetchAll(){
      // Personas
      let { data: personas } = await supabase
        .from(T_PERSONAS).select("*").order("created_at", { ascending:false });
      cache.personas = personas || [];

      // Bienes
      let { data: bienes } = await supabase
        .from(T_BIENES).select("*").order("created_at", { ascending:false });
      cache.bienes = bienes || [];

      // Servicios
      let { data: servicios } = await supabase
        .from(T_SERVICIOS).select("*").order("created_at", { ascending:false });
      cache.servicios = servicios || [];
    }

    function matchesSearch(row, fields){
      if(!searchTerm) return true;
      const t = searchTerm.toLowerCase();
      for(const f of fields){
        const val = (row[f]||"").toString().toLowerCase();
        if(val.includes(t)) return true;
      }
      return false;
    }

    function render(){
      $("#list-title").textContent = 
        activeTab==="todo" ? "Resultados" :
        activeTab==="personas" ? "Listado: Personal" :
        activeTab==="bienes" ? "Listado: Bienes" : "Listado: Servicios";

      // Filtrado
      const personas = cache.personas.filter(r => matchesSearch(r, ["nombres","dni","celular","ruc","direccion","cuenta","banco"]));
      const bienes   = cache.bienes.filter(r   => matchesSearch(r, ["nombre","empresa","ruc","celular","provee"]));
      const servs    = cache.servicios.filter(r=> matchesSearch(r, ["nombre","empresa","ruc","celular","servicio"]));

      // Render tablas
      $("#list-personas").innerHTML = tablePersonas(personas, activeTab!=="todo");
      $("#list-bienes").innerHTML   = tableBienes(bienes, activeTab!=="todo");
      $("#list-servicios").innerHTML= tableServicios(servs, activeTab!=="todo");

      // Mostrar/ocultar por tab
      $("#list-personas").style.display = (activeTab==="todo" || activeTab==="personas") ? "block" : "none";
      $("#list-bienes").style.display   = (activeTab==="todo" || activeTab==="bienes")   ? "block" : "none";
      $("#list-servicios").style.display= (activeTab==="todo" || activeTab==="servicios")? "block" : "none";
    }

    function tablePersonas(rows, compact){
      if(!rows.length) return '<div class="empty">Sin registros.</div>';
      let html = '<table><thead><tr>'+
        '<th>Nombres</th><th>DNI</th><th>Celular</th><th>RUC</th><th>Dirección</th><th>Cuenta</th><th>Banco</th>'+
      '</tr></thead><tbody>';
      html += rows.map(r=>'<tr>'+
        `<td>${esc(r.nombres)}</td>`+
        `<td>${esc(r.dni||"")}</td>`+
        `<td>${esc(r.celular||"")}</td>`+
        `<td>${esc(r.ruc||"")}</td>`+
        `<td>${esc(r.direccion||"")}</td>`+
        `<td>${esc(r.cuenta||"")}</td>`+
        `<td>${esc(r.banco||"")}</td>`+
      '</tr>').join('');
      html += '</tbody></table>';
      return html;
    }

    function tableBienes(rows){
      if(!rows.length) return '<div class="empty">Sin registros.</div>';
      let html = '<table><thead><tr>'+
        '<th>Proveedor</th><th>Empresa</th><th>RUC</th><th>Celular</th><th>¿Qué provee?</th>'+
      '</tr></thead><tbody>';
      html += rows.map(r=>'<tr>'+
        `<td>${esc(r.nombre)}</td>`+
        `<td>${esc(r.empresa||"")}</td>`+
        `<td>${esc(r.ruc||"")}</td>`+
        `<td>${esc(r.celular||"")}</td>`+
        `<td>${esc(r.provee||"")}</td>`+
      '</tr>').join('');
      html += '</tbody></table>';
      return html;
    }

    function tableServicios(rows){
      if(!rows.length) return '<div class="empty">Sin registros.</div>';
      let html = '<table><thead><tr>'+
        '<th>Proveedor</th><th>Empresa</th><th>RUC</th><th>Celular</th><th>Servicio</th>'+
      '</tr></thead><tbody>';
      html += rows.map(r=>'<tr>'+
        `<td>${esc(r.nombre)}</td>`+
        `<td>${esc(r.empresa||"")}</td>`+
        `<td>${esc(r.ruc||"")}</td>`+
        `<td>${esc(r.celular||"")}</td>`+
        `<td>${esc(r.servicio||"")}</td>`+
      '</tr>').join('');
      html += '</tbody></table>';
      return html;
    }

    function esc(s){
      return (s==null?"":String(s)).replace(/[&<>"']/g, c => ({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c]));
    }

    // ===== Buscar =====
    $("#q").addEventListener("input", (e)=>{
      searchTerm = e.target.value;
      render();
    });

    // ===== Export CSV =====
    $("#btnExport").addEventListener("click", ()=>{
      let rows = [];
      if(activeTab==="personas"){
        rows = cache.personas.filter(r=>matchesSearch(r,["nombres","dni","celular","ruc","direccion","cuenta","banco"]));
      } else if(activeTab==="bienes"){
        rows = cache.bienes.filter(r=>matchesSearch(r,["nombre","empresa","ruc","celular","provee"]));
      } else if(activeTab==="servicios"){
        rows = cache.servicios.filter(r=>matchesSearch(r,["nombre","empresa","ruc","celular","servicio"]));
      } else {
        // todo -> concatenado con tipo
        rows = [
          ...cache.personas.map(r=>({tipo:"personal", ...r})),
          ...cache.bienes.map(r=>({tipo:"bien", ...r})),
          ...cache.servicios.map(r=>({tipo:"servicio", ...r})),
        ];
      }
      const csv = toCSV(rows);
      const blob = new Blob([csv], {type:"text/csv;charset=utf-8;"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `export_${activeTab}.csv`;
      a.click();
      URL.revokeObjectURL(url);
    });

    function toCSV(rows){
      if(!rows.length) return "";
      const headers = Array.from(new Set(rows.flatMap(r=>Object.keys(r)))).filter(k=>!["id","user_id"].includes(k));
      const escF = v => `"${(v==null?"":String(v)).replace(/"/g,'""')}"`;
      let out = headers.join(",") + "\n";
      for(const r of rows){
        out += headers.map(h=>escF(r[h]??"")).join(",") + "\n";
      }
      return out;
    }

    // Go!
    init();
  </script>
</body>
</html>
