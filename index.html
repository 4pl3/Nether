<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Nether S.A.C.</title>

  <!-- NO CACHE -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">

  <!-- Google Icons (Material Symbols) -->
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" rel="stylesheet" />

  <!-- Fuente base -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />

  <style>
    :root{
      --font-family-base:"Inter",system-ui,-apple-system,"Segoe UI",Arial,Helvetica,sans-serif;
      --font-size-base:11px;
      --strip-height:22px;
      --strip-speed:26s;

      --brand:#0000ee;
      --border:#d7d7d7;
      --bg:#ffffff;
      --accent:#1e40af;
      --accent-2:#eef2ff;
      --danger:#c53030;
      --muted:#737373;
      --ok:#0d8a4e;
      --hover:#fff9c4;
      --radius:10px;
      --scroll:#bdbdbd;

      --gap:12px;
      --footer-h:38px;
      --wrap-mt:10px;

      /* Íconos */
      --icon-blue:#0000ff;          /* azul claro */
      --icon-size:18px;             /* tamaño general de íconos */
      --row-action-size:20px;       /* tamaño para lápiz/tacho */
    }

    *{box-sizing:border-box}
    html,body{min-height:100%}
    html{overflow:auto}
    body{
      margin:0;
      font-family:var(--font-family-base);
      font-size:var(--font-size-base);
      color:#1f2937;
      background:var(--bg);
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
      display:flex; flex-direction:column; min-height:100vh;
    }

    /* Material Symbols (tamaño/color global, SIN negrita) */
    .material-symbols-outlined{
      font-variation-settings:'FILL' 0,'wght' 300,'GRAD' 0,'opsz' 24;
      font-weight:300 !important;
      font-size:var(--icon-size);
      line-height:1;
      vertical-align:-2px;
      color:var(--icon-blue);
    }
    label .material-symbols-outlined{ font-weight:300 !important; }

    /* Sign out rojo */
    #btnSignOut .material-symbols-outlined{ color:#e53935; }
    #btnSignOut:hover .material-symbols-outlined{ color:#b71c1c; }

    h3{margin:0 0 6px;font-weight:700;color:#111827}

    .wrap{ max-width:1200px; margin:var(--wrap-mt) auto 0; padding:0 var(--gap); width:100%; flex:1 0 auto; }
    .app{
      border:1px solid var(--border); border-radius:12px; background:#fff; padding:12px;
      box-shadow:0 2px 12px rgba(0,0,0,.05); display:flex; flex-direction:column;
    }

    /* ====== Ticker ====== */
    .moving-strip{ width:100%; height:var(--strip-height); background:linear-gradient(to bottom,#ececec8c 0%,#ffffff 100%); overflow:hidden; position:sticky; top:0; z-index:30; border-radius:0; margin:0; padding:0 var(--gap); display:none; }
    .scroll-text{ position:absolute; top:0; left:12px; white-space:nowrap; display:inline-block; padding:0 .75rem; color:var(--brand); line-height:var(--strip-height); will-change:transform; visibility:hidden; transform:translateX(var(--start,0px)); animation:marqueePx var(--strip-speed) linear infinite; }
    @keyframes marqueePx{from{transform:translateX(var(--start));}to{transform:translateX(var(--end));}}

    /* ====== Grid principal ====== */
    .app-main{ display:grid; grid-template-columns:320px minmax(0,1fr); gap:var(--gap); align-items:start; min-height:0; min-width:0; }
    @media(max-width:980px){ .app-main{ grid-template-columns:1fr; } }

    /* ====== Topbar ====== */
    .topbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:8px}
    .search{flex:1;display:flex;align-items:center;gap:6px;border:1px solid var(--border);border-radius:10px;padding:6px 10px;background:#fafafa}
    .search input{border:none;outline:none;flex:1;font:inherit;background:transparent}
    .search input::placeholder{color:#9ca3af}
    .tabs{display:flex;gap:6px;flex-wrap:wrap}
    .tab{border:1px solid var(--border);border-radius:999px;padding:4px 10px;cursor:pointer;background:#f8f8f8;font:inherit;line-height:1.2;white-space:nowrap}
    .tab.active{background:var(--accent-2);border-color:#c3d0ff;color:#223}

    /* ====== Izquierda ====== */
    .left{ min-height:0; min-width:0; }
    .actions{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:8px}
    .btn{
      --pad-y:4px; --pad-x:10px;
      border:1px solid var(--border); border-radius:10px; background:#f7f8ff;
      padding:var(--pad-y) var(--pad-x); cursor:pointer; font:inherit; display:inline-flex; align-items:center; gap:6px; line-height:1.2; white-space:nowrap;
      user-select:none; transition:box-shadow .15s ease, transform .02s ease, background .15s ease, border-color .15s ease;
    }
    .btn:active{transform:translateY(1px)}
    .btn:hover{background:#eef2ff}
    .btn.primary{background:var(--accent-2);border-color:#c3d0ff}
    .btn.danger{background:#fff0f0;border-color:#f3c7c7}
    .btn.ghost{background:#fff}
    .btn.icon{padding:4px 6px}
    .btn:focus,.btn:focus-visible{outline:none; box-shadow:none}

    .section{margin-top:8px}
    .grid{display:grid;gap:6px}
    .cols-3{grid-template-columns:repeat(3,1fr)}
    .left .cols-3{grid-template-columns:1fr}
    @media(max-width:820px){ .cols-3{grid-template-columns:1fr} }

    label{font-weight:700;font-size:var(--font-size-base);display:flex;align-items:center;gap:6px}
    .field{display:flex;flex-direction:column;gap:3px}
    .field input,.field select,.field textarea{ border:1px solid var(--border); border-radius:8px; padding:5px 8px; font:inherit; outline:none; box-shadow:none; background:#fff }
    .field input:focus,.field select:focus,.field textarea:focus{border-color:var(--border); box-shadow:none; outline:none}
    .input-row{display:flex;align-items:center;gap:6px}

    /* ====== Derecha: tabla responsive ====== */
    .right{ display:flex; flex-direction:column; min-height:0; min-width:0; }
    .list-viewport{ flex:1; min-height:0; min-width:0; display:flex; flex-direction:column; }

    .table-wrap{
      border:1px solid var(--border);
      border-radius:10px;
      background:#fff;
      overflow:auto;
      max-width:100%;
      flex:1;
      min-height:0;
      position:relative;               /* necesario para FAB flotante */
      scrollbar-width:thin;
      scrollbar-color:var(--scroll) transparent;
    }
    .table-wrap::-webkit-scrollbar{width:6px;height:6px}
    .table-wrap::-webkit-scrollbar-thumb{background:var(--scroll);border-radius:6px}
    .table-wrap::-webkit-scrollbar-track{background:transparent}

    .table-wrap > table{
      width:max-content;
      min-width:100%;
      border-collapse:collapse;
      table-layout:auto;
    }
    .table-wrap th, .table-wrap td{
      white-space:nowrap !important; word-break:normal !important; overflow-wrap:normal !important; hyphens:none;
      border-bottom:1px solid #efefef; padding:6px 10px; text-align:left; vertical-align:top;
    }

    /* Cabecera sticky */
    .table-wrap th{ background:#f9fafb; position:sticky; top:0; z-index:2; color:#374151; font-weight:700; }

    /* Login */
    .auth-wrap{ display:grid; place-items:center; min-height:calc(100vh - var(--strip-height) - var(--footer-h) - (var(--wrap-mt) + 16px)); }
    .auth{ width:100%; max-width:340px; padding:12px; border:1px solid var(--border); border-radius:12px; background:#fff; box-shadow:0 2px 12px rgba(0,0,0,.05) }
    .auth-grid{grid-template-columns:1fr}

    footer{text-align:center;color:#808080;padding:10px 0 16px;flex:0 0 auto}

    .table-wrap tbody tr:hover{ background:var(--hover); }
    .table-wrap tbody tr.selected{ background:var(--hover); }

    /* ===== FAB DENTRO DE LA FILA (en cada <tr>) ===== */
    .table-wrap tbody tr{
      position: relative;                 /* el <tr> será el contenedor del FAB */
    }

    /* Botonera flotante pegada a la derecha de la fila */
    .row-fab{
      position: absolute;
      top: 50%;
      right: 6px;
      transform: translateY(-50%);
      display: flex;
      gap: 4px;
      align-items: center;
      padding: 2px;
      background: rgba(255,255,255,.98);
      border: 1px solid #e5e7eb;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,.10);
      z-index: 5;
      opacity: 0;
      pointer-events: none;
      transition: opacity .12s ease, transform .12s ease;
    }

    /* visible cuando la fila está activa/hover */
    .table-wrap tbody tr:hover .row-fab,
    .table-wrap tbody tr[data-editing="1"] .row-fab{
      opacity: 1;
      pointer-events: auto;
    }

    .fab-btn{
      border: none;
      background: transparent;
      padding: 2px;
      border-radius: 8px;
      cursor: pointer;
    }
    .fab-btn:hover{ background: rgba(0,0,255,.08); }

    /* Íconos pequeños y legibles (puedes ajustar a 14–18px si quieres) */
    .fab-btn .material-symbols-outlined{
      font-size: 16px;                    /* <- tamaño del ícono del FAB */
      line-height: 1;
      vertical-align: -2px;
    }

  </style>
</head>
<body>

  <!-- ====== Ticker ====== -->
  <div class="moving-strip" id="tickerWrap">
    <span class="scroll-text" id="ticker">Nether S.A.C. / Base de datos interna</span>
  </div>

  <div class="wrap">
    <!-- ====== LOGIN ====== -->
    <div id="authWrap" class="auth-wrap">
      <form id="auth-form" class="auth" autocomplete="on" novalidate>
        <h3 style="display:flex;align-items:center;gap:6px">
          <span class="material-symbols-outlined">lock</span>
          Iniciar sesión
        </h3>

        <div class="grid auth-grid" style="margin-top:8px">
          <div class="field">
            <label><span class="material-symbols-outlined">mail</span> Correo</label>
            <div class="input-row">
              <input id="auth-email" type="email" placeholder="tu@empresa.com" style="flex:1" />
            </div>
          </div>
          <div class="field">
            <label><span class="material-symbols-outlined">key</span> Contraseña</label>
            <div class="input-row">
              <input id="auth-pass" type="password" placeholder="••••••••" style="flex:1" />
              <button type="button" id="togglePass" class="btn ghost icon" title="Ver/Ocultar">
                <span class="material-symbols-outlined">visibility</span>
              </button>
            </div>
          </div>
        </div>

        <div style="margin-top:8px;display:flex;gap:8px;align-items:center">
          <button class="btn primary" id="btnLogin" type="submit">
            <span class="material-symbols-outlined">login</span> Ingresar
          </button>
          <div id="auth-msg" class="status"></div>
        </div>
      </form>
    </div>

    <!-- ====== APP (solo si hay sesión) ====== -->
    <div id="appBox" class="app" style="display:none">
      <div class="app-main">
        <!-- IZQUIERDA -->
        <aside class="left">
          <div class="actions">
            <button class="btn primary" id="btnPersonal"><span class="material-symbols-outlined">person</span> Personal</button>
            <button class="btn primary" id="btnBienes"><span class="material-symbols-outlined">inventory_2</span> Bienes</button>
            <button class="btn primary" id="btnServicios"><span class="material-symbols-outlined">home_repair_service</span> Servicios</button>
          </div>

          <!-- Formularios -->
          <div class="section" id="sec-persona" style="display:none">
            <h3><span class="material-symbols-outlined">badge</span> Personal</h3>
            <div class="grid cols-3">
              <div class="field"><label>Nombres completos</label><input id="p-nombres" /></div>
              <div class="field"><label>DNI</label><input id="p-dni" /></div>
              <div class="field"><label>Celular</label><input id="p-celular" /></div>
              <div class="field"><label>RUC</label><input id="p-ruc" /></div>
              <div class="field"><label>Dirección</label><input id="p-direccion" /></div>
              <div class="field"><label>N° Cuenta</label><input id="p-cuenta" /></div>
              <div class="field"><label>Banco</label><input id="p-banco" /></div>
            </div>
            <div style="margin-top:8px">
              <button class="btn primary" id="save-persona"><span class="material-symbols-outlined">save</span> Guardar</button>
              <span id="msg-persona" class="status"></span>
            </div>
          </div>

          <div class="section" id="sec-bien" style="display:none">
            <h3><span class="material-symbols-outlined">inventory_2</span> Bienes</h3>
            <div class="grid cols-3">
              <div class="field"><label>Nombre del proveedor</label><input id="b-nombre" /></div>
              <div class="field"><label>Empresa</label><input id="b-empresa" /></div>
              <div class="field"><label>RUC</label><input id="b-ruc" /></div>
              <div class="field"><label>Celular</label><input id="b-celular" /></div>
              <div class="field"><label>¿Qué provee?</label><input id="b-provee" /></div>
            </div>
            <div style="margin-top:8px">
              <button class="btn primary" id="save-bien"><span class="material-symbols-outlined">save</span> Guardar</button>
              <span id="msg-bien" class="status"></span>
            </div>
          </div>

          <div class="section" id="sec-serv" style="display:none">
            <h3><span class="material-symbols-outlined">home_repair_service</span> Servicios</h3>
            <div class="grid cols-3">
              <div class="field"><label>Nombre del proveedor</label><input id="s-nombre" /></div>
              <div class="field"><label>Empresa</label><input id="s-empresa" /></div>
              <div class="field"><label>RUC</label><input id="s-ruc" /></div>
              <div class="field"><label>Celular</label><input id="s-celular" /></div>
              <div class="field"><label>Servicio que brinda</label><input id="s-servicio" /></div>
            </div>
            <div style="margin-top:8px">
              <button class="btn primary" id="save-serv"><span class="material-symbols-outlined">save</span> Guardar</button>
              <span id="msg-serv" class="status"></span>
            </div>
          </div>
        </aside>

        <!-- DERECHA -->
        <section class="right">
          <div class="topbar">
            <div class="search" style="flex:1">
              <span class="material-symbols-outlined">search</span>
              <input id="q" type="search" placeholder="Buscar por nombre, DNI, RUC, celular, empresa, etc."/>
            </div>
            <div class="tabs">
              <button class="tab active" data-tab="todo">Todo</button>
              <button class="tab" data-tab="personas">Personal</button>
              <button class="tab" data-tab="bienes">Bienes</button>
              <button class="tab" data-tab="servicios">Servicios</button>
            </div>
            <button class="btn ghost" id="btnExport"><span class="material-symbols-outlined">file_export</span> Exportar CSV</button>
            <button class="btn danger icon" id="btnSignOut" title="Cerrar sesión"><span class="material-symbols-outlined">logout</span></button>
            <span id="conn" class="status">—</span>
          </div>

          <div class="list-viewport">
            <h3 id="list-title" style="margin-bottom:6px">Resultados</h3>
            <div id="lists" style="flex:1;min-height:0">
              <div class="section" id="list-personas"></div>
              <div class="section" id="list-bienes"></div>
              <div class="section" id="list-servicios"></div>
            </div>
          </div>
        </section>
      </div>
    </div>
  </div>

  <footer>Nether S.A.C.</footer>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    /* ======= CONFIG ======= */
    const SUPABASE_URL = "https://jvmecjufprxspcltwimm.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp2bWVjanVmcHJ4c3BjbHR3aW1tIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA2NzI0NTcsImV4cCI6MjA3NjI0ODQ1N30.nC7cax8JTH9EVyTHpD32ObCxsPgfyRBucz6wbAGviL0";

    const T_PERSONAS  = "personas";
    const T_BIENES    = "proveedores_bienes";
    const T_SERVICIOS = "proveedores_servicios";

    const TABLES = {
      personas : { table:T_PERSONAS,  cols:["nombres","dni","celular","ruc","direccion","cuenta","banco"] },
      bienes   : { table:T_BIENES,    cols:["nombre","empresa","ruc","celular","provee"] },
      servicios: { table:T_SERVICIOS, cols:["nombre","empresa","ruc","celular","servicio"] },
    };

    // (Opcional) Restringir correos por dominio
    const ALLOWED_DOMAINS = [];
    function isAllowedEmail(email){
      if(!ALLOWED_DOMAINS.length) return true;
      const domain = email.split('@')[1]?.toLowerCase();
      return ALLOWED_DOMAINS.includes(domain);
    }

    let activeTab = "todo";
    let searchTerm = "";
    let user = null;
    let cache = { personas: [], bienes: [], servicios: [] };

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    const $  = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

    function setConnStatus(ok){
      const el = $("#conn");
      if(!el) return;
      el.textContent = ok ? "Conectado" : "Sin conexión";
      el.className = "status " + (ok ? "ok" : "error");
    }

    // ===== Ticker =====
    function initTicker(){
      const el = document.getElementById('ticker');
      if(!el) return;
      function recalc(){
        const wrapW = el.parentElement.clientWidth;
        const textW = el.getBoundingClientRect().width;
        el.style.setProperty('--start', wrapW + 'px');
        el.style.setProperty('--end', -textW + 'px');
        el.style.visibility = 'visible';
      }
      setTimeout(recalc, 100);
      window.addEventListener('resize', recalc);
    }

    // ===== Auth & App init =====
    async function init(){
      setConnStatus(!!SUPABASE_URL && !!SUPABASE_ANON_KEY);
      const { data } = await supabase.auth.getUser();
      user = data?.user || null;
      toggleApp(!!user);

      if(user){
        initTicker();
        await fetchAll();
        render();
      }
    }

    function toggleApp(showApp){
      $("#authWrap").style.display  = showApp ? "none" : "grid";
      $("#appBox").style.display    = showApp ? "block" : "none";
      $("#tickerWrap").style.display= showApp ? "block" : "none";
    }

    // Mostrar/ocultar contraseña
    $("#togglePass")?.addEventListener("click", ()=>{
      const i = $("#auth-pass");
      if(!i) return;
      const showing = i.type === "text";
      i.type = showing ? "password" : "text";
      $("#togglePass span").textContent = showing ? "visibility" : "visibility_off";
    });

    // ===== Login =====
    async function doLogin(){
      const email = $("#auth-email").value.trim();
      const pass  = $("#auth-pass").value.trim();
      if(!isAllowedEmail(email)){
        $("#auth-msg").textContent = "Acceso restringido. Correo no autorizado.";
        return;
      }
      $("#auth-msg").textContent = "Ingresando...";
      const { data, error } = await supabase.auth.signInWithPassword({ email, password: pass });
      if(error){ $("#auth-msg").textContent = "Error: " + error.message; return; }
      user = data.user;
      $("#auth-msg").textContent = "Listo.";
      toggleApp(true);
      initTicker();
      await fetchAll(); render();
    }
    $("#auth-form").addEventListener("submit", async (e)=>{ e.preventDefault(); await doLogin(); });

    // ===== Cerrar sesión =====
    $("#btnSignOut").addEventListener("click", async () => {
      await supabase.auth.signOut();
      user = null;
      toggleApp(false);
      $("#auth-msg").textContent = "Sesión cerrada.";
    });

    // ===== Tabs =====
    $$(".tab").forEach(btn => {
      btn.addEventListener("click", () => {
        $$(".tab").forEach(x=>x.classList.remove("active"));
        btn.classList.add("active");
        activeTab = btn.getAttribute("data-tab");
        render();
      });
    });

    // ===== Mostrar formularios (izquierda) =====
    $("#btnPersonal").addEventListener("click", () => showForm("persona"));
    $("#btnBienes").addEventListener("click", () => showForm("bien"));
    $("#btnServicios").addEventListener("click", () => showForm("serv"));

    function showForm(which){
      $("#sec-persona").style.display = which==="persona" ? "block" : "none";
      $("#sec-bien").style.display    = which==="bien"    ? "block" : "none";
      $("#sec-serv").style.display    = which==="serv"    ? "block" : "none";
      document.querySelector('.left')?.scrollIntoView({ behavior:"smooth", block:"nearest" });
    }

    // ===== Guardar registros =====
    $("#save-persona").addEventListener("click", async () => {
      const payload = {
        nombres: $("#p-nombres").value.trim(),
        dni: $("#p-dni").value.trim(),
        celular: $("#p-celular").value.trim(),
        ruc: $("#p-ruc").value.trim(),
        direccion: $("#p-direccion").value.trim(),
        cuenta: $("#p-cuenta").value.trim(),
        banco: $("#p-banco").value.trim(),
        user_id: user?.id || null,
      };
      $("#msg-persona").textContent = "Guardando...";
      const { error } = await supabase.from(T_PERSONAS).insert(payload);
      if(error){ $("#msg-persona").textContent = "Error: "+error.message; return; }
      $("#msg-persona").textContent = "Guardado.";
      document.querySelectorAll("#sec-persona input").forEach(i=>i.value="");
      await fetchAll(); render();
    });

    $("#save-bien").addEventListener("click", async () => {
      const payload = {
        nombre: $("#b-nombre").value.trim(),
        empresa: $("#b-empresa").value.trim(),
        ruc: $("#b-ruc").value.trim(),
        celular: $("#b-celular").value.trim(),
        provee: $("#b-provee").value.trim(),
        user_id: user?.id || null,
      };
      $("#msg-bien").textContent = "Guardando...";
      const { error } = await supabase.from(T_BIENES).insert(payload);
      if(error){ $("#msg-bien").textContent = "Error: "+error.message; return; }
      $("#msg-bien").textContent = "Guardado.";
      await fetchAll(); render();
    });

    $("#save-serv").addEventListener("click", async () => {
      const payload = {
        nombre: $("#s-nombre").value.trim(),
        empresa: $("#s-empresa").value.trim(),
        ruc: $("#s-ruc").value.trim(),
        celular: $("#s-celular").value.trim(),
        servicio: $("#s-servicio").value.trim(),
        user_id: user?.id || null,
      };
      $("#msg-serv").textContent = "Guardando...";
      const { error } = await supabase.from(T_SERVICIOS).insert(payload);
      if(error){ $("#msg-serv").textContent = "Error: "+error.message; return; }
      $("#msg-serv").textContent = "Guardado.";
      await fetchAll(); render();
    });

    // ===== Fetch & Render =====
    async function fetchAll(){
      let { data: personas } = await supabase.from(T_PERSONAS).select("*").order("created_at",{ascending:false});
      cache.personas = personas || [];
      let { data: bienes } = await supabase.from(T_BIENES).select("*").order("created_at",{ascending:false});
      cache.bienes = bienes || [];
      let { data: servicios } = await supabase.from(T_SERVICIOS).select("*").order("created_at",{ascending:false});
      cache.servicios = servicios || [];
    }

    function matchesSearch(row, fields){
      if(!searchTerm) return true;
      const t = searchTerm.toLowerCase();
      for(const f of fields){
        const val = (row[f]||"").toString().toLowerCase();
        if(val.includes(t)) return true;
      }
      return false;
    }

    function tableWrap(innerHTML){ return `<div class="table-wrap">${innerHTML}</div>`; }

    /* === Tablas SIN columna Acciones === */
    function tablePersonas(rows){
      if(!rows.length) return '<div class="empty">Sin registros.</div>';
      let html = '<table><thead><tr>'+
        '<th>Nombres</th><th>DNI</th><th>Celular</th><th>RUC</th><th>Dirección</th><th>Cuenta</th><th>Banco</th>'+
      '</tr></thead><tbody>';
      html += rows.map(r=>`
        <tr data-type="personas" data-id="${r.id}">
          <td>${esc(r.nombres)}</td>
          <td>${esc(r.dni||"")}</td>
          <td>${esc(r.celular||"")}</td>
          <td>${esc(r.ruc||"")}</td>
          <td>${esc(r.direccion||"")}</td>
          <td>${esc(r.cuenta||"")}</td>
          <td>${esc(r.banco||"")}</td>
        </tr>`).join('');
      html += '</tbody></table>';
      return html;
    }

    function tableBienes(rows){
      if(!rows.length) return '<div class="empty">Sin registros.</div>';
      let html = '<table><thead><tr>'+
        '<th>Proveedor</th><th>Empresa</th><th>RUC</th><th>Celular</th><th>¿Qué provee?</th>'+
      '</tr></thead><tbody>';
      html += rows.map(r=>`
        <tr data-type="bienes" data-id="${r.id}">
          <td>${esc(r.nombre)}</td>
          <td>${esc(r.empresa||"")}</td>
          <td>${esc(r.ruc||"")}</td>
          <td>${esc(r.celular||"")}</td>
          <td>${esc(r.provee||"")}</td>
        </tr>`).join('');
      html += '</tbody></table>';
      return html;
    }

    function tableServicios(rows){
      if(!rows.length) return '<div class="empty">Sin registros.</div>';
      let html = '<table><thead><tr>'+
        '<th>Proveedor</th><th>Empresa</th><th>RUC</th><th>Celular</th><th>Servicio</th>'+
      '</tr></thead><tbody>';
      html += rows.map(r=>`
        <tr data-type="servicios" data-id="${r.id}">
          <td>${esc(r.nombre)}</td>
          <td>${esc(r.empresa||"")}</td>
          <td>${esc(r.ruc||"")}</td>
          <td>${esc(r.celular||"")}</td>
          <td>${esc(r.servicio||"")}</td>
        </tr>`).join('');
      html += '</tbody></table>';
      return html;
    }

    function render(){
      $("#list-title").textContent =
        activeTab==="todo" ? "Resultados" :
        activeTab==="personas" ? "Listado: Personal" :
        activeTab==="bienes" ? "Listado: Bienes" : "Listado: Servicios";

      const personas = cache.personas.filter(r => matchesSearch(r, ["nombres","dni","celular","ruc","direccion","cuenta","banco"]));
      const bienes   = cache.bienes.filter(r   => matchesSearch(r, ["nombre","empresa","ruc","celular","provee"]));
      const servs    = cache.servicios.filter(r=> matchesSearch(r, ["nombre","empresa","ruc","celular","servicio"]));

      $("#list-personas").innerHTML = tableWrap(tablePersonas(personas));
      $("#list-bienes").innerHTML   = tableWrap(tableBienes(bienes));
      $("#list-servicios").innerHTML= tableWrap(tableServicios(servs));

      $("#list-personas").style.display = (activeTab==="todo" || activeTab==="personas") ? "block" : "none";
      $("#list-bienes").style.display   = (activeTab==="todo" || activeTab==="bienes")   ? "block" : "none";
      $("#list-servicios").style.display= (activeTab==="todo" || activeTab==="servicios")? "block" : "none";
    }

    function esc(s){
      return (s==null ? "" : String(s)).replace(/[&<>"']/g, c => (
        {"&":"&amp;","<":"&lt;","&gt;":">&gt;","\"":"&quot;","'":"&#39;"}[c]
      ));
    }
    function escAttr(s){ return (s==null ? "" : String(s)).replace(/"/g,'&quot;'); }

    // Buscar
    $("#q").addEventListener("input", (e)=>{ searchTerm = e.target.value; render(); });

    // Export CSV
    $("#btnExport").addEventListener("click", ()=>{
      let rows = [];
      if(activeTab==="personas"){
        rows = cache.personas.filter(r=>matchesSearch(r,["nombres","dni","celular","ruc","direccion","cuenta","banco"]));
      } else if(activeTab==="bienes"){
        rows = cache.bienes.filter(r=>matchesSearch(r,["nombre","empresa","ruc","celular","provee"]));
      } else if(activeTab==="servicios"){
        rows = cache.servicios.filter(r=>matchesSearch(r,["nombre","empresa","ruc","celular","servicio"]));
      } else {
        rows = [
          ...cache.personas.map(r=>({tipo:"personal", ...r})),
          ...cache.bienes  .map(r=>({tipo:"bien",     ...r})),
          ...cache.servicios.map(r=>({tipo:"servicio", ...r})),
        ];
      }
      const csv = toCSV(rows);
      const blob = new Blob([csv], {type:"text/csv;charset=utf-8;"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = `export_${activeTab}.csv`; a.click();
      URL.revokeObjectURL(url);
    });

    function toCSV(rows){
      if(!rows.length) return "";
      const headers = Array.from(new Set(rows.flatMap(r=>Object.keys(r)))).filter(k=>!["id","user_id"].includes(k));
      const escF = v => `"${(v==null?"":String(v)).replace(/"/g,'""')}"`;
      let out = headers.join(",") + "\n";
      for(const r of rows){ out += headers.map(h=>escF(r[h]??"")).join(",") + "\n"; }
      return out;
    }

    // Selección de filas
    $("#lists").addEventListener("click", (e)=>{
      const tr = e.target.closest("tr");
      if(!tr) return;
      $$("#lists tr.selected").forEach(x=>x.classList.remove("selected"));
      tr.classList.add("selected");
    });

    /* ===== FAB flotante DENTRO de la fila (sin columna extra) ===== */
    function ensureFabInRow(tr){
      let fab = tr.querySelector('.row-fab');
      if(!fab){
        fab = document.createElement('div');
        fab.className = 'row-fab';
        fab.innerHTML = `
          <button class="fab-btn fab-edit" title="Editar">
            <span class="material-symbols-outlined">edit</span>
          </button>
          <button class="fab-btn fab-del" title="Eliminar">
            <span class="material-symbols-outlined">delete</span>
          </button>`;
        tr.appendChild(fab);
      }
      return fab;
    }

    function setFabMode(fab, mode){
      if(mode === 'edit'){
        fab.innerHTML = `
          <button class="fab-btn fab-save" title="Guardar">
            <span class="material-symbols-outlined">done</span>
          </button>
          <button class="fab-btn fab-cancel" title="Cancelar">
            <span class="material-symbols-outlined">close</span>
          </button>`;
      } else {
        fab.innerHTML = `
          <button class="fab-btn fab-edit" title="Editar">
            <span class="material-symbols-outlined">edit</span>
          </button>
          <button class="fab-btn fab-del" title="Eliminar">
            <span class="material-symbols-outlined">delete</span>
          </button>`;
      }
    }

    /* Mostrar FAB cuando entras a una fila; oculto al salir */
    const listsEl = document.getElementById('lists');

    listsEl.addEventListener('mouseenter', (e)=>{
      const tr = e.target.closest('tbody tr'); if(!tr) return;
      const fab = ensureFabInRow(tr);
      setFabMode(fab, tr.dataset.editing === '1' ? 'edit' : 'view');
    }, true);

    listsEl.addEventListener('mouseleave', (e)=>{
      const tr = e.target.closest('tbody tr'); if(!tr) return;
      const fab = tr.querySelector('.row-fab'); if(!fab) return;
      // se oculta por CSS al salir de la fila (opacity 0), no hace falta más
    }, true);

    /* Clicks del FAB dentro de la fila */
    document.addEventListener('click', async (e)=>{
      const btn = e.target.closest('.fab-edit,.fab-del,.fab-save,.fab-cancel');
      if(!btn) return;

      const tr = btn.closest('tr');                 // FAB está dentro del <tr>
      if(!tr) return;
      const type = tr.dataset.type;
      const id   = tr.dataset.id;
      const fab  = tr.querySelector('.row-fab');

      if(btn.classList.contains('fab-edit')){
        enterEdit(tr, type, id);
        setFabMode(fab, 'edit');
      } else if(btn.classList.contains('fab-del')){
        await doDelete(type, id);
        // al re-render se recrea el FAB automáticamente
      } else if(btn.classList.contains('fab-save')){
        await doSave(tr, type, id);
        // tras guardar, se re-renderiza; si no re-renderizas aquí, vuelve a modo vista:
        // setFabMode(fab, 'view');
      } else if(btn.classList.contains('fab-cancel')){
        render(); // cancela edición y re-renderiza
      }
    });


    // clicks del FAB
    document.addEventListener('click', async (e)=>{
      const btn = e.target.closest('.fab-edit,.fab-del,.fab-save,.fab-cancel');
      if(!btn) return;
      const fab  = btn.closest('.row-fab');
      const wrap = fab.parentElement;
      const id   = fab.dataset.targetId;
      const type = fab.dataset.targetType;
      const tr   = wrap.querySelector(`tr[data-type="${type}"][data-id="${CSS.escape(id)}"]`);
      if(!tr) return;

      if(btn.classList.contains('fab-edit')){
        enterEdit(tr, type, id);
        fab.innerHTML = `
          <button class="fab-btn fab-save" title="Guardar"><span class="material-symbols-outlined">done</span></button>
          <button class="fab-btn fab-cancel" title="Cancelar"><span class="material-symbols-outlined">close</span></button>`;
        placeFab(fab, wrap, tr);
      }else if(btn.classList.contains('fab-del')){
        await doDelete(type, id);
        hideFab(fab);
      }else if(btn.classList.contains('fab-save')){
        await doSave(tr, type, id);
        hideFab(fab);
      }else if(btn.classList.contains('fab-cancel')){
        render();
        hideFab(fab);
      }
    });

    /* edición inline sin columna */
    function enterEdit(tr, type, id){
      const cfg = TABLES[type]; if(!cfg) return;
      tr.dataset.editing = "1";
      const inputs = [];
      cfg.cols.forEach((field, i)=>{
        const td = tr.children[i];
        const current = td.textContent;
        td.innerHTML = `<input class="edit-input" data-field="${field}" value="${escAttr(current)}" />`;
        inputs.push(td.firstElementChild);
      });
      inputs.forEach(inp=>{
        inp.addEventListener("keydown", async (ev)=>{
          if(ev.key==="Enter"){ ev.preventDefault(); await doSave(tr, type, id); }
          if(ev.key==="Escape"){ ev.preventDefault(); render(); }
        });
      });
      inputs[0]?.focus();
    }

    async function doSave(tr, type, id){
      const cfg = TABLES[type]; if(!cfg) return;
      const payload = {};
      cfg.cols.forEach((field)=>{
        const val = tr.querySelector(`input[data-field="${field}"]`)?.value ?? "";
        payload[field] = val.trim();
      });
      const { error } = await supabase.from(cfg.table).update(payload).eq("id", id);
      if(error){ alert("Error al guardar: " + error.message); return; }
      await fetchAll(); render();
    }

    async function doDelete(type, id){
      const cfg = TABLES[type]; if(!cfg) return;
      if(!confirm("¿Borrar este registro?")) return;
      const { error } = await supabase.from(cfg.table).delete().eq("id", id);
      if(error){ alert("Error al borrar: " + error.message); return; }
      await fetchAll(); render();
    }

    // ===== ESC global =====
    function escReset(){
      const editing = document.querySelector('tr[data-editing="1"]');
      if(editing){ render(); return; }
      $$("#lists tr.selected").forEach(tr=>tr.classList.remove("selected"));
      ["persona","bien","serv"].forEach(id=>{
        const sec = document.getElementById("sec-"+id);
        if(sec && sec.style.display!=="none"){
          sec.querySelectorAll("input,textarea,select").forEach(i=>i.value="");
          sec.style.display="none";
        }
      });
      const ae = document.activeElement;
      if(ae && (ae.tagName==="INPUT" || ae.tagName==="TEXTAREA")) { ae.value=""; }
      ["msg-persona","msg-bien","msg-serv","auth-msg"].forEach(id=>{
        const m = document.getElementById(id); if(m) m.textContent="";
      });
    }
    document.addEventListener("keydown",(e)=>{
      if(e.key==="Escape"){ e.preventDefault(); escReset(); }
    });

    // Go!
    init();
  </script>
</body>
</html>
