<!DOCTYPE html> 
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Nether</title>

  <!-- üîπ Favicon SVG (tu pinwheel) -->
  <link rel="icon" href="./favicon.svg?v=2" type="image/svg+xml" sizes="any">
  <link rel="mask-icon" href="./favicon.svg?v=2" color="#c40000">
  <meta name="theme-color" content="#c40000">

  <!-- NO CACHE -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">

  <!-- Material Symbols (familia completa; evita √≠conos faltantes) -->
  <link rel="stylesheet"
    href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />

  <!-- Fuente base -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />

  <style>
    :root{
      --font-family-base:"Inter",system-ui,-apple-system,"Segoe UI",Arial,Helvetica,sans-serif;
      --font-size-base:11px;

      /* Alturas/gaps compactados */
      --strip-height:22px;
      --strip-speed:26s;
      --gap:10px;
      --wrap-mt:8px;

      --brand:#1e3a8a;
      --brand-2:#2563eb;
      --border:#d7d7d7;
      --bg:#ffffff;
      --accent:#1e40af;
      --accent-2:#eef2ff;
      --danger:#e53935;
      --muted:#6b7280;
      --ok:#16a34a;
      --hover:#fff9c4;
      --scroll:#bdbdbd;

      --footer-h:0px;

      /* √çconos */
      --icon-blue:#335eea;
      --icon-size:17px;
      --row-action-size:16px;

      /* Alto √≥ptico del encabezado y tama√±o de glifo del header */
      --hdr-h:22px;                                  /* mismo alto que usas en .list-header */
      --hdr-icn-size:var(--row-action-size);

      /* T√≠tulos/acciones izq (m√°s peque√±os) */
      --sec-title-size:13px;
      --sec-title-icon:18px;
      --action-icon-size:22px;

      /* Controles compactos */
      --ctl-h:20px;
      --ctl-radius:6px;
      --ctl-xpad:8px;

      /* Paleta ‚ÄúP√°ginas Amarillas‚Äù para la b√∫squeda */
      --yp-bg:#ffeb3b;
      --yp-bg-hover:#ffe866;
      --yp-border:#f3d15c;

      /* Offset y gap del √≠cono de b√∫squeda */
      --search-icn-offset: 5px;
      --search-icn-gap: 26px;

      /* üîπ Espacio y posici√≥n del bot√≥n X (clear) */
      --search-clear-gap: 28px;     /* reserva dentro del input */
      --search-clear-right: 4px;    /* ‚Äúun poco m√°s a la derecha‚Äù del borde */    

      /* Empuje de toolbar derecha */
      --hdr-push: 14px;

      /* Grosor ultra fino de scroll en listados */
      --scroll-w: 2px; /* recontrafino */
    }

    *{box-sizing:border-box}
    html,body{min-height:100%}
    html{overflow:auto}
    body{
      margin:0;
      font-family:var(--font-family-base);
      font-size:var(--font-size-base);
      color:#1f2937;
      background:var(--bg);
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
      display:flex; flex-direction:column; min-height:100vh;
    }

    /* ===== Material Symbols ===== */
    .material-symbols-outlined{
      font-family: "Material Symbols Outlined";
      font-weight: normal;
      font-style: normal;
      font-size: var(--icon-size);
      line-height: 1;
      letter-spacing: normal;
      text-transform: none;
      display: inline-block;
      white-space: nowrap;
      word-wrap: normal;
      direction: ltr;
      /* est√°ndar: asegura ligaduras sin el prefijo obsoleto */
      font-variant-ligatures: normal;
      font-feature-settings: "liga" 1;
      -webkit-font-smoothing: antialiased;
      font-variation-settings:'FILL' 0,'wght' 400,'GRAD' 0,'opsz' 24;
      vertical-align:-2px;
      color:var(--icon-blue);
      transition:transform .12s ease, filter .12s ease;
    }

    .search .material-symbols-outlined{ color:#000 !important; }
    .btn.primary .material-symbols-outlined{ color:var(--brand); }
    /* DESPU√âS: morado y hover m√°s oscuro (igual estilo que Cerrar sesi√≥n) */
    #btnExport .material-symbols-outlined{ color:#7c3aed; }       /* morado */
    #btnExport:hover .material-symbols-outlined{ color:#5b21b6; } /* morado oscuro al hover */
    #btnSignOut .material-symbols-outlined{ color:#e53935; }
    #btnSignOut:hover .material-symbols-outlined{ color:#b71c1c; }

    .hdr-actions .tb-edit    .material-symbols-outlined{ color:#1e88e5; }
    .hdr-actions .tb-del     .material-symbols-outlined{ color:#ef4444; }
    .hdr-actions .tb-save    .material-symbols-outlined{ color:#16a34a; }
    .hdr-actions .tb-cancel  .material-symbols-outlined{ color:#6b7280; }

    h3{margin:0 0 6px;font-weight:700;color:#111827}

    .wrap{ max-width:1200px; margin:var(--wrap-mt) auto 0; padding:0 var(--gap); width:100%; flex:1 0 auto; }
    .app{
      border:1px solid var(--border); border-radius:12px; background:#fff; padding:10px;
      box-shadow:0 2px 12px rgba(0,0,0,.05); display:flex; flex-direction:column;
    }

    /* Login */
    .auth-wrap{ display:grid; place-items:center; min-height:calc(100vh - var(--strip-height) - var(--footer-h) - (var(--wrap-mt) + 12px)); }
    .auth{
      width:100%; max-width:240px; padding:10px; border:1px solid var(--border); border-radius:10px; background:#fff;
      box-shadow:0 2px 12px rgba(0,0,0,.05);
    }
    .auth-title{ margin:2px 0 8px; text-align:center; font-size:12px; font-weight:700; color:#0f172a; }

    /* Ticker */
    .moving-strip{ width:100%; height:var(--strip-height); background:linear-gradient(to bottom,#ececec8c 0%,#ffffff 100%); overflow:hidden; position:sticky; top:0; z-index:30; border-radius:0; margin:0; padding:0 var(--gap); display:none; }
    .scroll-text{ position:absolute; top:0; left:12px; white-space:nowrap; display:inline-block; padding:0 .75rem; color:var(--brand); line-height:var(--strip-height); will-change:transform; visibility:hidden; transform:translateX(var(--start,0px)); animation:marqueePx var(--strip-speed) linear infinite; }
    @keyframes marqueePx{from{transform:translateX(var(--start));}to{transform:translateX(var(--end));}}

    /* Grid principal */
    .app-main{ display:grid; grid-template-columns:300px minmax(0,1fr); gap:var(--gap); align-items:start; min-height:0; min-width:0; }
    @media(max-width:980px){ .app-main{ grid-template-columns:1fr; } }

    /* === TOPBAR EMPAQUETADA Y UNIFORME === */
    .topbar{
      display:flex;
      align-items:center;
      flex-wrap:wrap;             /* permite 2 l√≠neas si no entra */
      column-gap:8px;             /* separaci√≥n horizontal pareja */
      row-gap:6px;                /* si ‚Äúsalta‚Äù a otra l√≠nea, queda prolijo */
      margin-bottom:8px;
      min-height:var(--ctl-h);
    }

    /* todos los hijos sin m√°rgenes externos ‚Äúfantasma‚Äù */
    .topbar > *{ margin:0 !important; }

    /* === Estado ‚ÄúConectado‚Äù del mismo alto y alineado a los costados === */
    #conn{
      display:inline-flex;
      align-items:center;
      height:var(--ctl-h);
      line-height:var(--ctl-h);
      padding:0 8px;               /* un pel√≠n m√°s parejo con tabs */
      border:1px solid #e5e7eb;
      border-radius:999px;
      margin:0;                    /* sin desplazamientos laterales */
    }

    .status.ok{ color:var(--ok); }
    .status.error{ color:var(--danger); }

    /* Barra de b√∫squeda estilo "p√°ginas amarillas" */
    .search{
      position:relative; flex:1; display:flex; align-items:center;
      border:1px solid var(--yp-border); border-radius:var(--ctl-radius);
      height:var(--ctl-h); padding:0 var(--ctl-xpad); padding-left:var(--search-icn-gap);
      background:var(--yp-bg);
      transition:background .15s ease, border-color .15s ease, box-shadow .15s ease;
    }
    .search:hover{ background:var(--yp-bg-hover); border-color:#e0b94d; }
    .search:focus-within{ box-shadow:none !important; border-color:var(--yp-border) !important; outline:none !important; }
    .search .icn{
      position:absolute; left:var(--search-icn-offset); top:50%; transform:translateY(-50%);
      font-size:18px; color:#000 !important; pointer-events:none; opacity:.9;
    }
    .search input{
      border:none; outline:none; flex:1; font:inherit; background:transparent; height:100%;
      padding:0; padding-right:var(--search-clear-gap);  /* üîπ reserva espacio para la X */
      line-height:var(--ctl-h); color:#000;
    }

    .search input::placeholder{ color:#000; opacity:.65; }

    .tabs{display:flex;gap:6px;flex-wrap:wrap}
    .tab{
      display:inline-flex; align-items:center; justify-content:center;
      border:1px solid var(--border); border-radius:var(--ctl-radius);
      height:var(--ctl-h); padding:0 var(--ctl-xpad); cursor:pointer;
      background:#f8f8f8; font:inherit; white-space:nowrap; line-height:1;
      transition:transform .06s ease, box-shadow .15s ease, background .15s ease, border-color .15s ease;
    }
    .tab:hover{ background:#fffef0; border-color:#f3e28a; box-shadow:0 2px 8px rgba(0,0,0,.06); transform:translateY(-1px); }
    .tab:active{ transform:translateY(0); box-shadow:none; }
    .tab.active{background:var(--accent-2);border-color:#c3d0ff;color:#223}

    .btn{
      display:inline-flex; align-items:center; gap:6px; white-space:nowrap;
      border:1px solid var(--border); border-radius:var(--ctl-radius);
      height:var(--ctl-h); padding:0 var(--ctl-xpad); cursor:pointer; font:inherit;
      background:#f7f8ff; user-select:none;
      transition:box-shadow .15s ease, transform .06s ease, background .15s ease, border-color .15s ease, opacity .15s ease;
    }
    .btn:hover{background:#eef2ff;border-color:#c3d0ff;box-shadow:0 2px 8px rgba(0,0,0,.06);transform:translateY(-1px)}
    .btn:active{transform:translateY(0);box-shadow:none}
    .btn.primary{background:var(--accent-2);border-color:#c3d0ff}
    .btn.danger{background:#fff0f0;border-color:#f3c7c7}
    .btn.ghost{background:#fff}
    .btn.icon{width:var(--ctl-h); padding:0; justify-content:center}
    .btn[disabled]{opacity:.6; pointer-events:none}
    .tab:focus,.tab:focus-visible,
    .act-icon:focus,.act-icon:focus-visible,
    .act-btn:focus,.act-btn:focus-visible,
    button:focus, button:focus-visible { outline:none !important; box-shadow:none !important; }

    /* Izquierda */
    .left{ min-height:0; min-width:0; }
    .actions{ display:flex; flex-wrap:wrap; justify-content:center; align-items:center; gap:12px; margin-bottom:2px; }
    .act-icon{ border:none; background:transparent; padding:4px; line-height:1; cursor:pointer; border-radius:8px; }
    .act-icon .material-symbols-outlined{ font-size:var(--action-icon-size); color:var(--brand-2); vertical-align:middle; }
    .act-icon:hover .material-symbols-outlined{ filter:brightness(.85); transform:translateY(-1px); }

    /* Estado vac√≠o */
    .left-empty{
      margin:8px auto 0; padding:12px 10px; border:1px dashed #e5e7eb; border-radius:10px; text-align:center; color:#6b7280;
      max-width:92%; display:none;
    }
    .left-empty .smiley-icn{ font-size:56px; line-height:1; display:inline-block; color:var(--brand-2); animation:bounce 1.8s ease-in-out infinite; user-select:none; margin-bottom:6px; }
    @keyframes bounce{ 0%,100%{ transform:translateY(0) scale(1);} 50%{ transform:translateY(-4px) scale(1.04);} }
    .left-empty .msg{ font-size:11px; margin-top:2px; }

    .section{margin-top:8px}
    .sec-title{ display:flex; align-items:center; justify-content:center; gap:6px; margin:10px 0 6px; font-size:var(--sec-title-size); font-weight:700; color:#111827; text-align:center; }
    .sec-title .material-symbols-outlined{ font-size:var(--sec-title-icon); vertical-align:middle; color:#1e3a8a; }

    /* altura EXACTA y bordes alineados a tabs/√≠conos */
    .topbar .search{
      height:var(--ctl-h);
      min-width:240px;             /* evita que se achate demasiado */
    }

    /* asegura que la X quede dentro sin ‚Äúsangrar‚Äù el borde derecho */
    .topbar .search .clear-btn{
      right:var(--search-clear-right);
    }

    /* ===== Estado vac√≠o en la DERECHA (pesta√±a TODO sin b√∫squeda) ===== */
    .right-empty{
      margin:8px auto 0;
      padding:12px 10px;
      border:1px dashed #e5e7eb;
      border-radius:10px;
      text-align:center;
      color:#6b7280;
      max-width:92%;
      display:none;              /* se muestra solo en TODO sin b√∫squeda */
      cursor:pointer;
      user-select:none;
    }
    /* Sin contorno al hacer click o enfocar el panel vac√≠o de la derecha */
    .right-empty:focus,
    .right-empty:focus-visible,
    .right-empty:focus-within{
      outline:none !important;
      box-shadow:none !important;
    }

    /* Evita el halo azul/violeta en m√≥viles (Android/Chrome) */
    .right-empty{
      -webkit-tap-highlight-color: transparent;
    }

    /* Por si en el futuro el √≠cono se vuelve focusable */
    .right-empty .big-icn:focus,
    .right-empty .big-icn:focus-visible{
      outline:none !important;
      box-shadow:none !important;
    }

    .right-empty .big-icn{
      font-size:56px;
      line-height:1;
      display:inline-block;
      margin-bottom:6px;

      color:#00000051;                     /* marr√≥n fuerte (Material Brown 700) */
      animation:none !important;         /* desactiva cualquier animaci√≥n previa */
      font-variation-settings:'FILL' 0,'wght' 500,'GRAD' 0,'opsz' 48; /* contorno */
    }

    .right-empty .msg{ font-size:11px; margin-top:2px; }

    /* Formularios COMPACTOS */
    .grid{display:grid;gap:4px}
    .cols-3{grid-template-columns:repeat(3,1fr)}
    .left .cols-3{grid-template-columns:1fr}
    @media(max-width:820px){ .cols-3{grid-template-columns:1fr} }

    label{font-weight:600;font-size:10.5px;display:flex;align-items:center;gap:6px}
    .field{display:flex;flex-direction:column;gap:2px}
    .field input,.field select,.field textarea{
      border:1px solid var(--border);
      border-radius:6px;
      padding:3px 6px;
      font:inherit; outline:none; box-shadow:none; background:#fff;
      height:24px;
    }
    .field textarea{min-height:48px;height:auto}
    .field input:focus,.field select:focus,.field textarea:focus{border-color:var(--border); box-shadow:none; outline:none}
    .input-row{display:flex;align-items:center;gap:6px}

    /* Derecha */
    .right{ display:flex; flex-direction:column; min-height:0; min-width:0; }
    .list-viewport{ flex:1; min-height:0; min-width:0; display:flex; flex-direction:column; position:relative; }
    /* Encabezado de resultados: respiraci√≥n vertical coherente con la topbar */
    .list-header{
      min-height:var(--hdr-h);
      max-width:100%;
      margin:4px 0;
    }

    /* El marco interno sigue sirviendo para centrar la toolbar */
    .list-header-inner{
      position:relative;
      display:flex; align-items:center; gap:8px;
      margin-left:0; margin-right:0;   /* los laterales los ajusta syncHeaderToTable() */
    }

    #list-title.col-title{
      display:flex;
      align-items:center;          /* centra verticalmente el texto */
      margin:0;                    /* sin empuje extra arriba/abajo */
      line-height:var(--hdr-h);    /* misma caja que el header */
    }

    /* Toolbar centrada SIEMPRE respecto al ancho del listado */
    .hdr-actions{
      position:absolute;                /* <- centrado absoluto dentro del marco */
      left:50%; top:50%;
      transform:translate(-50%,-50%);   /* <- centro exacto */
      display:flex; align-items:center; justify-content:center;
      gap:10px;
      min-width:0;                      /* ya no forzamos ancho m√≠nimo */
      visibility:hidden; opacity:0; transition:opacity .12s ease;
      margin:0;                         /* quitamos empujes laterales */
      pointer-events:auto;
      z-index:1;                        /* delante del t√≠tulo si coincide */
    }
    .hdr-actions.show{ visibility:visible; opacity:1; }
    .hdr-actions button{ border:none; background:transparent; padding:0; line-height:1; cursor:pointer; }
    .hdr-actions .material-symbols-outlined{
      font-size:var(--hdr-icn-size);
      line-height:1;
      vertical-align:middle;                            /* alinea por centroides */
      /* fuerza opsz al mismo tama√±o del glifo para mejor aspecto √≥ptico */
      font-variation-settings:'FILL' 0,'wght' 400,'GRAD' 0,'opsz' var(--hdr-icn-size);
    }
    .hdr-actions button:hover .material-symbols-outlined{ filter:brightness(.85); }

    .list-section{ position:relative; }
    .right .section{ margin-top:2px; }

    /* ===== TABLA / LISTADOS ===== */
    .table-wrap{
      border:1px solid var(--border);
      border-radius:0;                /* SIN bordes redondeados (recto) */
      background:#fff;
      overflow:auto;                  /* scroll hor/vert */
      max-width:100%;
      flex:1;
      min-height:0;

      /* Scroll s√∫per delgado en Firefox */
      scrollbar-width:thin;
      scrollbar-color:var(--scroll) transparent;
    }
    .table-wrap::-webkit-scrollbar{ width:var(--scroll-w); height:var(--scroll-w); }
    .table-wrap::-webkit-scrollbar-thumb{ background:var(--scroll); border-radius:0; }
    .table-wrap::-webkit-scrollbar-track{ background:transparent; }
    .table-wrap::-webkit-scrollbar-corner{ background:transparent; }

    .table-wrap > table{
      width:max-content;
      min-width:100%;
      border-collapse:separate;
      border-spacing:0;
      table-layout:auto;
    }

    /* DESPU√âS ‚Äî celdas centradas verticalmente en TODOS los listados */
    .table-wrap th,
    .table-wrap td{
      white-space:nowrap !important;
      word-break:normal !important;
      overflow-wrap:normal !important;
      hyphens:none;
      padding:3px 6px;
      text-align:left;              /* ‚Üê no tocamos el centrado horizontal */
      vertical-align:middle;        /* ‚Üê CENTRADO VERTICAL GLOBAL */
      border-bottom:1px solid #efefef;
    }

    /* Refuerzo de alineaci√≥n vertical en todas las zonas de la tabla */
    .table-wrap thead th,
    .table-wrap tbody td,
    .table-wrap tfoot td{
      vertical-align:middle !important;
    }

    /* Solo filas de datos (tbody) en Arial y negro */
    .table-wrap tbody td{
      font-family: Arial, "Helvetica Neue", Helvetica, sans-serif !important;
      color:#000 !important;
      font-weight:400;
    }

    /* inputs en edici√≥n dentro del tbody */
    .table-wrap tbody td .edit-input{
      font-family: Arial, "Helvetica Neue", Helvetica, sans-serif !important;
      color:#000 !important;
    }

    .table-wrap thead th{
      position:sticky; top:0; z-index:2;
      background:#f0f0f0; color:#0000ff !important; font-weight:400; /* ‚Üê azul Inventario */
      padding:2px 6px; line-height:1.05;
      border-bottom:1px solid #e1e1e1;

      /* üîΩ Centramos el texto del encabezado */
      text-align:center;       /* horizontal */
      vertical-align:middle;   /* vertical   */
    }

    .table-wrap thead th + th{ border-left:1px solid #e6e6e6; }
    .table-wrap tbody td + td{ border-left:1px solid #efefef; }

    /* Inventario: centrar columnas Marca, Cantidad, Precio y Total */
    #list-inventario .table-wrap td[data-field="marca"],
    #list-inventario .table-wrap td[data-field="cantidad"],
    #list-inventario .table-wrap td[data-field="precio_ref"],
    #list-inventario .table-wrap td[data-field="__total"]{
      text-align: center;
      vertical-align: middle;
      font-variant-numeric: tabular-nums; /* n√∫meros m√°s alineados */
    }

    .table-wrap tbody tr{ cursor:pointer; }
    .table-wrap tbody tr:hover{ background:var(--hover); }
    .table-wrap tbody tr.selected{ background:var(--hover); }

    /* Evita que el navegador intente seleccionar texto al hacer clic/arrastrar */
    .table-wrap tbody{
      -webkit-user-select: none;
      -moz-user-select: none;
      user-select: none;
    }

    /* Pero permite seleccionar dentro de inputs cuando est√©s editando */
    .table-wrap tr[data-editing="1"] .edit-input{
      -webkit-user-select: text;
      -moz-user-select: text;
      user-select: text;
    }

    /* ===== TOTAL EN INVENTARIO (igual al ENCABEZADO + STICKY + tipograf√≠a del t√≠tulo) ===== */
    .table-wrap tfoot td{
      position: sticky;          /* siempre visible dentro del scroll */
      bottom: 0;
      z-index: 3;                /* por encima de tbody y thead (thead usa 2) */
      background:#f0f0f0;        /* mismo fondo que thead */
      border-top:1px solid #e1e1e1; /* misma l√≠nea que thead */
      padding:2px 6px;           /* mismo padding que thead */
      line-height:1.05;          /* mismo line-height que thead */
      text-align:center;         /* default general */
      vertical-align:middle;

      /* Tipograf√≠a del t√≠tulo "Base de Datos" */
      font-weight:400;
      color:var(--muted);
    }

    /* Bordes verticales como en thead */
    .table-wrap tfoot td + td{
      border-left:1px solid #e6e6e6;
    }

    /* Detalles sem√°nticos del total */
    .table-wrap tfoot .tot-label{ /* etiqueta TOTAL GENERAL */
      text-align:center;
    }
    .table-wrap tfoot .tot-valor{ /* n√∫mero */
      font-variant-numeric: tabular-nums;
    }

    /* === OVERRIDE SOLO PARA INVENTARIO (ajuste de Total General) === */
    /* Etiqueta "Total General" (colspan): derecha y azul */
    #list-inventario .table-wrap tfoot .tot-label{
      text-align: right !important;
      color: #0000ff !important;
    }

    /* Valor del Total General: CENTRADO, Arial, tama√±o de fila y AZUL */
    #list-inventario .table-wrap tfoot .tot-valor{
      text-align: center !important;
      font-family: Arial, "Helvetica Neue", Helvetica, sans-serif !important;
      font-size: var(--font-size-base) !important;
      font-weight: 400 !important;
      color: #0000ff !important;
      font-variant-numeric: tabular-nums;
      vertical-align: middle; /* por si la celda es m√°s alta */
    }

    .table-wrap td{ position:relative; }
    .cell-ghost{
      /* vuelve a estar en el flujo para mantener la altura de la celda */
      visibility:hidden;
      pointer-events:none;
      white-space:inherit;
      display:block;
      min-height:1em; /* ancla m√≠nima de altura */
    }

    /* DESPU√âS ‚Äî el texto del input se percibe centrado verticalmente */
    .edit-input{
      position:absolute; inset:0; z-index:1;
      width:100%; height:100%;
      margin:0; padding:3px 6px;            /* padding sim√©trico arriba/abajo */
      box-sizing:border-box;
      border:none !important;
      background:transparent !important;
      border-radius:0;
      font:inherit; font-weight:400 !important;
      line-height:1.2;                       /* ‚Üê fija una altura de l√≠nea estable */
      box-shadow:none !important; outline:none !important;
      -webkit-appearance:none; appearance:none;
    }

    /* Inventario (modo edici√≥n): centrar texto dentro de los inputs */
    .table-wrap tr[data-type="inventario"] .edit-input[data-field="marca"],
    .table-wrap tr[data-type="inventario"] .edit-input[data-field="cantidad"],
    .table-wrap tr[data-type="inventario"] .edit-input[data-field="precio_ref"],
    .table-wrap tr[data-type="inventario"] .edit-input[data-field="__total"]{
      text-align: center;
    }

    /* FILA EN EDICI√ìN: anaranjado fuerte transl√∫cido */
    .table-wrap tr[data-editing="1"],
    .table-wrap tr[data-editing="1"]:hover{
      background:rgba(0, 76, 255, 0.22) !important; /* mismo RGB que tu captura, con alpha */
    }

    /* Input en la fila editando: borde/anuncio naranja */
    .table-wrap tr[data-editing="1"] .edit-input{
      border:none !important;
      background:transparent !important;
    }

    .edit-input:focus{ border-color:transparent; box-shadow:none; outline:none; }
    .edit-input::placeholder{ color:#9ca3af; font-weight:400; }

    .save-row{ margin-top:6px; display:flex; align-items:center; gap:6px; min-height:24px; }
    .status{ font-size:11px; color:var(--muted); }
    .status.ok{ color:var(--ok); }

    /* === Hover verde en √≠conos de la barra izquierda === */
    .actions .act-icon .material-symbols-outlined{
      color: var(--brand-2);
    }
    .actions .act-icon:hover .material-symbols-outlined{
      color: var(--ok) !important;
      filter: none;
      transform: translateY(-1px);
    }

    /* === √çconos del TOPBAR: caja invisible pero del MISMO alto que todo === */
    .topbar .act-icon{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      width:var(--ctl-h);          /* cuadradito como los tabs */
      height:var(--ctl-h);
      padding:0;                   /* sin ‚Äúaire‚Äù extra */
      border:none;                 /* sin contenedor visible */
      background:transparent;      /* queda solo el √≠cono */
      border-radius:var(--ctl-radius);
      outline:none;
    }

    /* microalineaci√≥n del glifo para que ‚Äúasiente‚Äù en la l√≠nea */
    .topbar .act-icon .material-symbols-outlined{
      font-size:18px;
      line-height:1;
      vertical-align:-2px;
    }

    /* ===== T√≠tulo por columna (responsive) ===== */
    .col-title{
      text-align:center;
      font-size:var(--font-size-base); /* mismo tama√±o que "Pulsa un √≠cono..." */
      color:var(--muted);
      line-height:1.2;
      font-weight:400;
      user-select:none;
      margin:2px 0 6px;
    }

    /* DESPU√âS ‚Äî Usuario alineado a la izquierda */
    #user-display{
      /* .col-title ya define fuente/tama√±o/line-height */
      margin: 0 0 4px;          /* pegado a ‚ÄúFormulario‚Äù */
      text-align: left;         /* << ALINEADO A LA IZQUIERDA */
    }
    #title-form{
      margin-top: 0;            /* ‚ÄúFormulario‚Äù queda como estaba (centrado) */
    }

    /* M√°s espacio debajo del t√≠tulo 'Base de Datos' */
    .right > .col-title{
      margin-bottom: 12px; /* s√∫belo a 14px o 16px si lo quieres m√°s separado */
    }

    /* T√≠tulos sobre cada listado (mismo estilo que "Formulario") */
    .list-title{
      /* reusa la tipograf√≠a/estilo de .col-title al usar ambas clases en el HTML */
      margin:10px 0 6px;
    }

    /* Opcional: si quieres un poco m√°s de aire en la primera secci√≥n del lado derecho cuando hay t√≠tulos */
    #lists .list-section:first-child .list-title{
      margin-top: 12px;
    }

    
    /* Oculta la X nativa del <input type="search"> en WebKit */
    .search input::-webkit-search-cancel-button{
      -webkit-appearance: none;
      appearance: none;
    }

    /* Bot√≥n X dentro del buscador */
    .search .clear-btn{
      position:absolute;
      top:50%;
      right:var(--search-clear-right);
      transform:translateY(-50%);
      display:none;                 /* aparece s√≥lo con texto */
      align-items:center;
      justify-content:center;
      width:18px; height:18px;
      border:none; background:transparent; padding:0; cursor:pointer;
    }
    .search .clear-btn .material-symbols-outlined{
      font-size:18px; line-height:1;
      color:#000; opacity:.75;     /* mismo tono del √≠cono de lupa */
      transition:transform .12s ease, opacity .12s ease;
    }
    .search .clear-btn:hover .material-symbols-outlined{
      opacity:1; transform:scale(1.05);
    }

    /* ===== Modal compacto dentro de la p√°gina ===== */
    body.modal-open{ overflow:hidden; }

    .modal-overlay{
      position:fixed; inset:0; display:none; align-items:center; justify-content:center;
      background:rgba(0,0,0,.22); z-index:9999;
    }

    /* Modal m√°s COMPACTO y ajustado al contenido */
    .modal{
      display:inline-grid;               /* shrink-to-fit para que se ajuste al contenido */
      width:auto;                        /* sin ancho fijo */
      max-width:calc(100vw - 32px);      /* l√≠mite de seguridad en pantallas peque√±as */
      border:1px solid var(--border);
      border-radius:12px;
      background:#fff;
      padding:8px;                       /* antes 10px */
      gap:6px;                           /* antes 8px */
      box-shadow:0 8px 24px rgba(0,0,0,.14);
      text-align:center;
    }

    .modal .col-title{
      font-size:var(--font-size-base);
      line-height:1.15;                  /* m√°s cerrado */
      font-weight:400;
      color:#111827;
      margin:0 0 2px;                    /* menos aire bajo el t√≠tulo */
    }

    .modal-msg{
      font:inherit; color:#000;
      margin:0;                          /* sin margen extra */
      line-height:1.2;                   /* compacto */
    }

    /* Contenedor de botones COMPACTO y centrado */
    .modal-actions{
      display:inline-flex;               /* se ajusta al ancho de los botones */
      align-items:center;
      justify-content:center;
      gap:6px;                           /* antes 8px */
      margin:0 auto;                     /* sin margen superior extra */
    }

    /* Botones ajustados al texto (sin estirar) */
    .modal-actions .btn{
      flex:1 1 auto;                     /* NO llenar todo el ancho */
      min-width:auto;
      height:var(--ctl-h);               /* respeta tu altura global de controles */
      padding:0 8px;                     /* m√°s compacto */
      white-space:nowrap;                /* que no parta el texto */
      color:#000 !important;             /* letra negra, como pediste */
    }

    /* (opcional) icono un pel√≠n m√°s compacto dentro del bot√≥n */
    .modal-actions .btn .material-symbols-outlined{
      font-size:16px;
      vertical-align:-2px;
    }

    /* Ojo afuera del input, sin contenedor */
    .toggle-eye{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      width:var(--ctl-h);
      height:var(--ctl-h);
      margin-left:4px;        /* separadito del input */
      cursor:pointer;
      background:transparent;
      border:none;
      user-select:none;
      color:#000 !important;
    }

    /* feedback al pasar el mouse */
    .toggle-eye:hover{ filter:brightness(.85); }

    /* ===== Marca en el ticker (Nether + RUC) ===== */
    #ticker{
      /* Arial solicitada (con fallbacks est√°ndar) */
      font-family: Arial, "Helvetica Neue", Helvetica, sans-serif !important;

      /* Mismo color que los encabezados (azul de tus thead th) */
      color: #0000ff !important;

      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* ‚ÄúS.A.C.‚Äù 2 veces m√°s peque√±o que el resto */
    #ticker .mini-sac{
      font-size: 0.75em;           /* 2√ó m√°s peque√±o */
      line-height: 1;
      vertical-align: baseline;
    }

</style>
</head>
<body>

  <!-- ===== Modal compacto reutilizable (AHORA DENTRO DEL BODY) ===== -->
  <div id="modal-overlay" class="modal-overlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modal-title">
      <div id="modal-title" class="col-title" style="margin:0">Confirmaci√≥n</div>
      <div id="modal-msg" class="modal-msg">Mensaje</div>
      <div class="modal-actions">
        <button id="modal-ok" class="btn primary">
          <span class="material-symbols-outlined">done</span> Aceptar
        </button>
        <button id="modal-cancel" class="btn ghost">
          <span class="material-symbols-outlined">close</span> Cancelar
        </button>
      </div>
    </div>
  </div>

  <!-- Ticker -->
  <div class="moving-strip" id="tickerWrap">
    <span class="scroll-text" id="ticker">
      NETHER <span class="mini-sac">S.A.C.</span> / R.U.C. : 20613159216
    </span>
  </div>

  <div class="wrap">
    <!-- LOGIN -->
    <div id="authWrap" class="auth-wrap">
      <form id="auth-form" class="auth" autocomplete="on" novalidate>
        <h3 class="auth-title">Iniciar sesi√≥n</h3>

        <div class="grid auth-grid" style="margin-top:6px">
          <div class="field">
            <label><span class="material-symbols-outlined">mail</span> Correo</label>
            <div class="input-row">
              <input id="auth-email" type="email" placeholder="tu@correo.com" style="flex:1" />
            </div>
          </div>
          <div class="field">
            <label><span class="material-symbols-outlined">key</span> Contrase√±a</label>
            <div class="input-row">
              <input id="auth-pass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" style="flex:1" />
              <span id="togglePass" class="material-symbols-outlined toggle-eye" title="Ver/Ocultar" aria-label="Ver/Ocultar">
                visibility
              </span>
            </div>
          </div>
        </div>

        <!-- DESPU√âS -->
        <div class="save-row" style="gap:6px; flex-wrap:wrap">
          <button class="btn primary" id="btnLogin" type="submit">
            <span class="material-symbols-outlined">login</span> Ingresar
          </button>

          <button class="btn ghost" id="btnSignUp" type="button" title="Crear cuenta nueva">
            <span class="material-symbols-outlined">person_add</span> Crear cuenta
          </button>

          <div id="auth-msg" class="status"></div>
        </div>
      </form>
    </div>

    <!-- APP -->
    <div id="appBox" class="app" style="display:none">
      <div class="app-main">
        <!-- IZQUIERDA -->
        <aside class="left">
          <!-- NUEVO: r√≥tulo con el usuario actual (misma tipograf√≠a que ‚ÄúFormulario‚Äù) -->
          <div class="col-title" id="user-display" style="display:none"></div>

          <div class="col-title" id="title-form">Formulario</div>

          <div class="actions">
            <button class="act-icon" id="btnPersonal"  title="Personal"><span class="material-symbols-outlined">article_person</span></button>
            <button class="act-icon" id="btnBienes"    title="Bienes"><span class="material-symbols-outlined">package_2</span></button>
            <button class="act-icon" id="btnServicios" title="Servicios"><span class="material-symbols-outlined">service_toolbox</span></button>
            <button class="act-icon" id="btnInventario" title="Inventario"><span class="material-symbols-outlined">trolley</span></button>
          </div>

          <!-- Estado vac√≠o -->
          <div id="left-empty" class="left-empty">
            <span class="material-symbols-outlined smiley-icn" aria-hidden="true">add_reaction</span>
            <div class="msg">Pulsa un √≠cono de arriba para ingresar informaci√≥n.</div>
          </div>

          <!-- Formularios -->
          <!-- ======== PERSONAL ======== -->
          <div class="section" id="sec-persona" style="display:none">
            <h3 class="sec-title"><span class="material-symbols-outlined">article_person</span> Personal</h3>
            <div class="grid cols-3">
              <div class="field"><label>Categor√≠a</label><input id="p-categoria" /></div>
              <div class="field"><label>Nombres</label><input id="p-nombres" /></div>
              <div class="field"><label>Apellidos</label><input id="p-apellidos" /></div>

              <div class="field"><label>DNI</label><input id="p-dni" /></div>
              <div class="field"><label>Celular</label><input id="p-celular" /></div>
              <div class="field"><label>R.U.C.</label><input id="p-ruc" /></div>

              <div class="field"><label>Direcci√≥n</label><input id="p-direccion" /></div>
              <div class="field"><label>Tipo de Cuenta</label><input id="p-tipo_cuenta" /></div>
              <div class="field"><label>N√∫mero de Cuenta</label><input id="p-numero_cuenta" /></div>

              <div class="field"><label>C.C.I.</label><input id="p-cci" /></div>
              <div class="field"><label>Nombre del Banco</label><input id="p-banco" /></div>
              <div class="field"><label>Correo</label><input id="p-correo" type="email" /></div>
            </div>
            <div class="save-row">
              <button class="btn primary" id="save-persona"><span class="material-symbols-outlined">save</span> Guardar</button>
              <span id="msg-persona" class="status"></span>
            </div>
          </div>

          <!-- ======== BIENES ======== -->
          <div class="section" id="sec-bien" style="display:none">
            <h3 class="sec-title"><span class="material-symbols-outlined">package_2</span> Bienes</h3>
            <div class="grid cols-3">
              <div class="field"><label>Nombre del Proveedor</label><input id="b-nombre" /></div>
              <div class="field"><label>Empresa</label><input id="b-empresa" /></div>
              <div class="field"><label>R.U.C</label><input id="b-ruc" /></div>
              <div class="field"><label>Celular</label><input id="b-celular" /></div>
              <div class="field"><label>¬øQu√© bien provee?</label><input id="b-provee" /></div>
            </div>
            <div class="save-row">
              <button class="btn primary" id="save-bien"><span class="material-symbols-outlined">save</span> Guardar</button>
              <span id="msg-bien" class="status"></span>
            </div>
          </div>

          <!-- ======== SERVICIOS ======== -->
          <div class="section" id="sec-serv" style="display:none">
            <h3 class="sec-title"><span class="material-symbols-outlined">service_toolbox</span> Servicios</h3>
            <div class="grid cols-3">
              <div class="field"><label>Nombre del Proveedor</label><input id="s-nombre" /></div>
              <div class="field"><label>Empresa</label><input id="s-empresa" /></div>
              <div class="field"><label>R.U.C</label><input id="s-ruc" /></div>
              <div class="field"><label>Celular</label><input id="s-celular" /></div>
              <div class="field"><label>¬øQu√© servicio provee?</label><input id="s-servicio" /></div>
            </div>
            <div class="save-row">
              <button class="btn primary" id="save-serv"><span class="material-symbols-outlined">save</span> Guardar</button>
              <span id="msg-serv" class="status"></span>
            </div>
          </div>

          <!-- ======== INVENTARIO (NUEVO) ======== -->
          <div class="section" id="sec-inv" style="display:none">
            <h3 class="sec-title"><span class="material-symbols-outlined">trolley</span> Inventario</h3>
            <div class="grid cols-3">
              <div class="field"><label>Producto</label><input id="i-producto" /></div>
              <div class="field"><label>Marca</label><input id="i-marca" /></div>
              <div class="field"><label>Cantidad</label><input id="i-cantidad" type="number" step="1" min="0" /></div>
              <div class="field"><label>Precio Referencial (S/)</label><input id="i-precio_ref" type="number" step="0.01" min="0" /></div>
            </div>
            <div class="save-row">
              <button class="btn primary" id="save-inv"><span class="material-symbols-outlined">save</span> Guardar</button>
              <span id="msg-inv" class="status"></span>
            </div>
          </div>

        </aside>

        <!-- DERECHA -->
        <section class="right">
          <div class="col-title" id="title-db">Base de Datos</div>
          <div class="topbar">
            <div class="search">
              <span class="material-symbols-outlined icn">database_search</span>
              <input id="q" type="search" placeholder="Buscador"/>
              <button type="button" class="clear-btn" id="q-clear" title="Limpiar">
                <span class="material-symbols-outlined">close_small</span>
              </button>
            </div>
            <div class="tabs">
              <button class="tab active" data-tab="todo">Todo</button>
              <button class="tab" data-tab="personas">Personal</button>
              <button class="tab" data-tab="bienes">Bienes</button>
              <button class="tab" data-tab="servicios">Servicios</button>
              <button class="tab" data-tab="inventario">Inventario</button>
            </div>
            <button class="act-icon" id="btnExport" title="Exportar CSV" aria-label="Exportar CSV">
              <span class="material-symbols-outlined">file_export</span>
            </button>
            <button class="act-icon" id="btnSignOut" title="Cerrar sesi√≥n">
              <span class="material-symbols-outlined">waving_hand</span>
            </button>
            <span id="conn" class="status">‚Äî</span>
          </div>

          <div class="list-viewport">

            <div id="listHeader" class="list-header" style="display:none">
              <div id="listHeaderInner" class="list-header-inner">
                <div id="list-title" class="col-title" aria-live="polite"></div>
                <div id="hdr-actions" class="hdr-actions" aria-hidden="true">
                  <button class="act-btn tb-edit" title="Editar"><span class="material-symbols-outlined">stylus_note</span></button>
                  <button class="act-btn tb-del"  title="Eliminar"><span class="material-symbols-outlined">delete</span></button>
                </div>
              </div>
            </div>

            <!-- Panel vac√≠o que aparece en TODO sin b√∫squeda -->
            <div id="right-empty" class="right-empty" role="button" tabindex="0"
                title="Haz clic para buscar">
              <span class="material-symbols-outlined big-icn" aria-hidden="true">database_search</span>
              <div class="msg">
                Dame clic para empezar a buscar <b>personal, bienes, servicios o inventario</b>.
              </div>
            </div>

            <div id="lists" style="flex:1;min-height:0">
              <div class="section" id="list-personas"></div>
              <div class="section" id="list-bienes"></div>
              <div class="section" id="list-servicios"></div>
              <div class="section" id="list-inventario"></div>
            </div>
          </div>
        </section>
      </div>
    </div>
  </div>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    /* ======= CONFIG ======= */
    const SUPABASE_URL = "https://jvmecjufprxspcltwimm.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp2bWVjanVmcHJ4c3BjbHR3aW1tIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA2NzI0NTcsImV4cCI6MjA3NjI0ODQ1N30.nC7cax8JTH9EVyTHpD32ObCxsPgfyRBucz6wbAGviL0";

    const T_PERSONAS   = "personas";
    const T_BIENES     = "proveedores_bienes";
    const T_SERVICIOS  = "proveedores_servicios";
    const T_INVENTARIO = "inventario"; // NUEVA TABLA

    const TABLES = {
      personas : { table:T_PERSONAS,
        cols:["categoria","nombres","apellidos","dni","celular","ruc","direccion","tipo_cuenta","numero_cuenta","cci","banco","correo"]
      },
      bienes   : { table:T_BIENES,    cols:["nombre","empresa","ruc","celular","provee"] },
      servicios: { table:T_SERVICIOS, cols:["nombre","empresa","ruc","celular","servicio"] },
      inventario:{ table:T_INVENTARIO, cols:["producto","marca","cantidad","precio_ref"] }  // EDITABLES
    };

    const BASE_PERSONA_COLS = ["nombres","dni","celular","ruc","direccion","cuenta","banco"];

    // DESPU√âS
    // üîí Correos EXACTOS autorizados para CREAR cuenta (edita esta lista)
    const ALLOWED_EMAILS = [ "m19151313@gmail.com", "esaudcr@gmail.com","VICDAE.1V9M9C4@GMAIL.COM"
      // "tucorreo@nether.com.pe",
      // "admin@nether.com.pe",
    ];

    // (opcional) Dominios completos autorizados para CREAR cuenta
    const ALLOWED_DOMAINS = [ 
      // "nether.com.pe",
      // "muni.gob.pe",
    ];

    // Solo controla la CREACI√ìN de cuentas (no el login)
    function canSignUpEmail(email){
      const e = String(email||"").trim().toLowerCase();
      const domain = e.split("@")[1] || "";

      // normaliza listas por si pusiste MAY√öSCULAS
      const allowedEmails  = ALLOWED_EMAILS.map(s => String(s||"").toLowerCase());
      const allowedDomains = ALLOWED_DOMAINS.map(s => String(s||"").toLowerCase());

      if (allowedEmails.length  && allowedEmails.includes(e))      return true;
      if (allowedDomains.length && allowedDomains.includes(domain)) return true;
      return false;
    }

    let activeTab = "todo";
    let searchTerm = "";
    let user = null;
    let cache = { personas: [], bienes: [], servicios: [], inventario: [] };

    /* üîπ Ancla para selecci√≥n por rango (Shift) */
    let lastAnchorRow = null;

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    const $  = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

    /* ===== Helpers de modal: confirm/alert en p√°gina ===== */
    function uiShow(options){
      const { title="Confirmaci√≥n", message="", showCancel=true, okText="Aceptar", cancelText="Cancelar" } = options || {};
      const ov = $("#modal-overlay");
      if(!ov) return Promise.resolve(false);

      $("#modal-title").textContent = title;
      $("#modal-msg").textContent = message;
      $("#modal-ok").innerHTML = `<span class="material-symbols-outlined">done</span> ${okText}`;
      $("#modal-cancel").innerHTML = `<span class="material-symbols-outlined">close</span> ${cancelText}`;
      $("#modal-cancel").style.display = showCancel ? "inline-flex" : "none";

      return new Promise(resolve=>{
        const onOk = ()=>{ cleanup(); resolve(true);  };
        const onCancel = ()=>{ cleanup(); resolve(false); };
        const onKey = (e)=>{ if(e.key==="Escape") onCancel(); if(e.key==="Enter") onOk(); };

        function cleanup(){
          document.removeEventListener("keydown", onKey);
          $("#modal-ok").removeEventListener("click", onOk);
          $("#modal-cancel").removeEventListener("click", onCancel);
          ov.style.display = "none"; ov.setAttribute("aria-hidden","true");
          document.body.classList.remove("modal-open");
        }

        document.addEventListener("keydown", onKey);
        $("#modal-ok").addEventListener("click", onOk);
        $("#modal-cancel").addEventListener("click", onCancel);

        ov.style.display = "flex"; ov.removeAttribute("aria-hidden");
        document.body.classList.add("modal-open");
        $("#modal-ok").focus({ preventScroll:true });
      });
    }

    function uiConfirm(message, title="Confirmaci√≥n"){
      return uiShow({ title, message, showCancel:true });
    }
    function uiAlert(message, title="Aviso"){
      return uiShow({ title, message, showCancel:false, okText:"Entendido" });
    }

    function setConnStatus(ok){
      const el = $("#conn");
      if(!el) return;
      el.textContent = ok ? "Conectado" : "Sin conexi√≥n";
      el.className = "status " + (ok ? "ok" : "error");
    }

    // Ticker
    function initTicker(){
      const el = document.getElementById('ticker');
      if(!el) return;
      function recalc(){
        const wrapW = el.parentElement.clientWidth;
        const textW = el.getBoundingClientRect().width;
        el.style.setProperty('--start', wrapW + 'px');
        el.style.setProperty('--end', -textW + 'px');
        el.style.visibility = 'visible';
      }
      setTimeout(recalc, 100);
      window.addEventListener('resize', recalc);
    }

    /* === Usuario visible sobre ‚ÄúFormulario‚Äù =============================== */
    function extractUserNameFromEmail(email){
      const e = String(email || "").trim();
      return e.includes("@") ? e.split("@")[0] : e;
    }
    function updateUserDisplay(){
      const box = document.getElementById("user-display");
      if(!box) return;

      const email = user?.email || "";
      if(email){
        const name = extractUserNameFromEmail(email);
        box.textContent = "usuario: " + (name || "‚Äî");
        box.style.display = "block";
      }else{
        box.textContent = "";
        box.style.display = "none";
      }
    }

    // Detectar tabla visible
    function getVisibleTableWrap(){
      const order = [
        ["todo", "#list-personas"],
        ["personas", "#list-personas"],
        ["bienes", "#list-bienes"],
        ["servicios", "#list-servicios"],
        ["inventario", "#list-inventario"],
      ];
      const targetSel = (order.find(x => x[0] === activeTab)?.[1]) || "#list-personas";
      const first = document.querySelector(`${targetSel} .table-wrap`);
      return first || document.querySelector(".table-wrap");
    }

    // Alinear header con listado
    function syncHeaderToTable(){
      const inner = document.getElementById("listHeaderInner");
      const tw = getVisibleTableWrap();
      const vp = document.querySelector(".list-viewport");
      if(!inner || !tw || !vp) return;

      const rTW = tw.getBoundingClientRect();
      const rVP = vp.getBoundingClientRect();

      const padL = Math.max(0, Math.round(rTW.left - rVP.left));
      const padR = Math.max(0, Math.round(rVP.right - rTW.right));

      inner.style.marginLeft  = padL + "px";
      inner.style.marginRight = padR + "px";
    }
    window.addEventListener("resize", syncHeaderToTable);

    /* ===== Snapshot de scroll por secci√≥n ===== */
    function getScrollState(){
      const ids = ["personas","bienes","servicios","inventario"];
      const st = {};
      ids.forEach(id=>{
        const wrap = document.querySelector(`#list-${id} .table-wrap`);
        if(wrap){
          st[id] = { left: wrap.scrollLeft, top: wrap.scrollTop };
        }
      });
      return st;
    }
    function restoreScrollState(st){
      if(!st) return;
      Object.entries(st).forEach(([id, pos])=>{
        const wrap = document.querySelector(`#list-${id} .table-wrap`);
        if(wrap){
          wrap.scrollLeft = pos.left || 0;
          wrap.scrollTop  = pos.top  || 0;
        }
      });
    }

    /* ================================
       L√çMITE DE FILAS SEG√öN PESTA√ëA
       - "todo": 3 filas antes de scroll
       - resto : 20 filas antes de scroll
       ================================ */
    function enforceScrollLimit(){
      const inSearchOnTodo = (activeTab === "todo") && (String(searchTerm || "").trim().length > 0);

      document.querySelectorAll("#lists .list-section").forEach(section=>{
        const wrap = section.querySelector(".table-wrap");
        if(!wrap) return;

        // Si la secci√≥n est√° oculta, limpia l√≠mites y contin√∫a
        const secDisplay = getComputedStyle(section).display;
        if(secDisplay === 'none'){
          wrap.style.maxHeight = "";
          wrap.style.overflowY = "";
          return;
        }

        // üîì MODO "SIN RESTRICCIONES" cuando est√°s en TODO y hay b√∫squeda
        if (inSearchOnTodo){
          wrap.style.maxHeight = "";
          wrap.style.overflowY = "";
          return; // ‚Üê no aplicamos ning√∫n l√≠mite
        }

        const table = wrap.querySelector("table");
        if(!table){
          wrap.style.maxHeight = "";
          wrap.style.overflowY = "";
          return;
        }

        const thead = table.tHead;
        const tfoot = table.tFoot;
        const tbody = table.tBodies[0];
        const rows  = tbody ? Array.from(tbody.rows) : [];
        const count = rows.length;

        // Mant√©n tus reglas originales cuando NO est√°s buscando en TODO:
        // - TODO: 3 filas (threshold 2 por tu c√°lculo actual)
        // - Otras pesta√±as: 20 filas (threshold 21 por tu c√°lculo actual)
        const threshold = (activeTab === "todo") ? 2 : 21;

        if(count > threshold){
          // Buscar una fila con alto medible
          const visibleRow = rows.find(r => r.offsetParent !== null) || rows[0];
          let rowH = visibleRow ? visibleRow.getBoundingClientRect().height : 26;
          if(!rowH || rowH === 0) rowH = 26;

          const headH = thead ? Math.ceil(thead.getBoundingClientRect().height) : 0;
          const footH = tfoot ? Math.ceil(tfoot.getBoundingClientRect().height) : 0;

          // Sumamos el alto del tfoot para que nunca tape la √∫ltima fila
          const maxH  = Math.ceil(headH + rowH * threshold + footH + 2);

          wrap.style.maxHeight = maxH + "px";
          wrap.style.overflowY = "auto";
        }else{
          wrap.style.maxHeight = "";
          wrap.style.overflowY = "";
        }
      });
    }

    window.addEventListener("resize", enforceScrollLimit);

    // Realtime
    function initRealtime(){
      const tables = ["personas","proveedores_bienes","proveedores_servicios","inventario"];
      tables.forEach(tbl=>{
        const ch = supabase.channel('rt_'+tbl)
          .on('postgres_changes', { event:'*', schema:'public', table:tbl }, async (_payload)=>{
            await fetchAll(); render(); syncHeaderToTable();
          })
          .subscribe();
      });
    }
    function stopRealtime(){
      try{ supabase.getChannels().forEach(ch => supabase.removeChannel(ch)); }catch(e){}
    }

    // Mostrar/ocultar vac√≠o
    function updateLeftEmpty(){
      const empty = $("#left-empty");
      const vis = ($("#sec-persona").style.display==="none" &&
                   $("#sec-bien").style.display==="none" &&
                   $("#sec-serv").style.display==="none" &&
                   $("#sec-inv").style.display==="none");
      empty.style.display = vis ? "block" : "none";
    }

    // Auth & App init
    async function init(){
      setConnStatus(!!SUPABASE_URL && !!SUPABASE_ANON_KEY);
      const { data } = await supabase.auth.getUser();
      user = data?.user || null;
      toggleApp(!!user);

      if(user){
        updateUserDisplay();         // ‚Üê NUEVO
        initTicker();
        await fetchAll();
        render();
        syncHeaderToTable();
        initRealtime();
        updateLeftEmpty();
      }
    }

    function toggleApp(showApp){
      $("#authWrap").style.display  = showApp ? "none" : "grid";
      $("#appBox").style.display    = showApp ? "block" : "none";
      $("#tickerWrap").style.display= showApp ? "block" : "none";
    }

      $("#togglePass")?.addEventListener("click", ()=>{
        const i = $("#auth-pass"); if(!i) return;
        const showing = i.type === "text";
        i.type = showing ? "password" : "text";
        $("#togglePass").textContent = showing ? "visibility" : "visibility_off";
      });

    // Login
    async function doLogin(){
      const email = $("#auth-email").value.trim();
      const pass  = $("#auth-pass").value.trim();
      const btn   = $("#btnLogin");

      $("#auth-msg").textContent = "Conectando...";
      btn.disabled = true;

      const { data, error } = await supabase.auth.signInWithPassword({ email, password: pass });
      if(error){
        $("#auth-msg").textContent = "Error: " + error.message;
        btn.disabled = false;
        return;
      }

      user = data.user;
      $("#auth-msg").textContent = "Listo.";
      toggleApp(true);
      updateUserDisplay();                 // ‚Üê NUEVO
      initTicker();

      await fetchAll();
      render();
      syncHeaderToTable();
      stopRealtime(); initRealtime();
      btn.disabled = false;
      updateLeftEmpty();
    }

    // ===== Registro restringido por allowlist (Supabase v2) =====
    async function doSignUp(){
      const email = $("#auth-email").value.trim();
      const pass  = $("#auth-pass").value.trim();
      const msg   = $("#auth-msg");
      const btnL  = $("#btnLogin");
      const btnS  = $("#btnSignUp");

      if(!email || !pass){
        msg.textContent = "Escribe correo y contrase√±a para crear la cuenta.";
        return;
      }
      if(!canSignUpEmail(email)){
        msg.textContent = "Correo NO autorizado para crear cuenta.";
        return;
      }

      msg.textContent = "Creando cuenta...";
      btnL?.setAttribute("disabled", "disabled");
      btnS?.setAttribute("disabled", "disabled");

      try{
        const { data, error } = await supabase.auth.signUp({ email, password: pass });

        if(error){
          msg.textContent = "Error: " + error.message;
          return;
        }

        // Si tienes confirmaci√≥n por email activada en Supabase:
        if(!data.session){
          msg.textContent = "Cuenta creada. Revisa tu correo para confirmar.";
          return;
        }

        // Si no requiere confirmaci√≥n, entra directo:
        user = data.user;
        msg.textContent = "Cuenta creada y sesi√≥n iniciada.";
        toggleApp(true);
        updateUserDisplay();                 // ‚Üê NUEVO
        initTicker();
        await fetchAll(); render(); syncHeaderToTable();
        stopRealtime(); initRealtime();
        updateLeftEmpty();
      }catch(err){
        msg.textContent = "Error inesperado: " + (err?.message || err);
      }finally{
        btnL?.removeAttribute("disabled");
        btnS?.removeAttribute("disabled");
      }
    }

    // Click en "Crear cuenta"
    $("#btnSignUp")?.addEventListener("click", doSignUp);
        

    $("#auth-form").addEventListener("submit", async (e)=>{ e.preventDefault(); await doLogin(); });
    $("#auth-form").addEventListener("keydown", async (e)=>{ if(e.key==="Enter"){ e.preventDefault(); await doLogin(); }});

    // Cerrar sesi√≥n
    $("#btnSignOut").addEventListener("click", async () => {
      stopRealtime();
      toggleApp(false);
      $("#auth-msg").textContent = "Sesi√≥n cerrada.";
      user = null;
      cache = { personas:[], bienes:[], servicios:[], inventario:[] };
      // Oculta el r√≥tulo del usuario
      const ud = document.getElementById("user-display");
      if(ud){ ud.style.display = "none"; ud.textContent = ""; }
      try{ await supabase.auth.signOut(); }catch(_e){}
    });

    // Tabs
    $$(".tab").forEach(btn => {
      btn.addEventListener("click", () => {
        $$(".tab").forEach(x=>x.classList.remove("active"));
        btn.classList.add("active");
        activeTab = btn.getAttribute("data-tab");
        render();
      });
    });

    // Formularios (izquierda)
    $("#btnPersonal").addEventListener("click", () => showForm("persona"));
    $("#btnBienes").addEventListener("click", () => showForm("bien"));
    $("#btnServicios").addEventListener("click", () => showForm("serv"));
    $("#btnInventario").addEventListener("click", () => showForm("inv"));

    function showForm(which){
      $("#sec-persona").style.display = which==="persona" ? "block" : "none";
      $("#sec-bien").style.display    = which==="bien"    ? "block" : "none";
      $("#sec-serv").style.display    = which==="serv"    ? "block" : "none";
      $("#sec-inv").style.display     = which==="inv"     ? "block" : "none";
      document.querySelector('.left')?.scrollIntoView({ behavior:"smooth", block:"nearest" });
      updateLeftEmpty();
    }

    // Mensajes y validaci√≥n
    function flashSaved(sel){
      const el = typeof sel==="string" ? $(sel) : sel;
      if(!el) return;
      el.textContent = "Guardado.";
      el.classList.add("ok");
      setTimeout(()=>{ el.textContent=""; el.classList.remove("ok"); }, 1200);
    }

    /* ======= SAVE: PERSONAL ======= */
    async function savePersona(){
      const payload = {
        categoria     : $("#p-categoria").value.trim(),
        nombres       : $("#p-nombres").value.trim(),
        apellidos     : $("#p-apellidos").value.trim(),
        dni           : $("#p-dni").value.trim(),
        celular       : $("#p-celular").value.trim(),
        ruc           : $("#p-ruc").value.trim(),
        direccion     : $("#p-direccion").value.trim(),
        tipo_cuenta   : $("#p-tipo_cuenta").value.trim(),
        numero_cuenta : $("#p-numero_cuenta").value.trim(),
        cci           : $("#p-cci").value.trim(),
        banco         : $("#p-banco").value.trim(),
        correo        : $("#p-correo").value.trim(),
        user_id       : user?.id || null,
      };

      const hasContent = Object.entries(payload)
        .some(([k,v]) => k!=="user_id" && String(v||"").trim().length>0);
      if(!hasContent){
        $("#msg-persona").classList.remove("ok");
        $("#msg-persona").textContent = "Digite alg√∫n campo para poder guardar.";
        return;
      }

      $("#msg-persona").textContent = "Guardando...";
      let { error } = await supabase.from(T_PERSONAS).insert(payload);

      if(error){
        const fb = {
          nombres  : [payload.nombres, payload.apellidos].filter(Boolean).join(" ").trim(),
          dni      : payload.dni,
          celular  : payload.celular,
          ruc      : payload.ruc,
          direccion: payload.direccion,
          cuenta   : payload.numero_cuenta,
          banco    : payload.banco,
          user_id  : payload.user_id
        };
        ({ error } = await supabase.from(T_PERSONAS).insert(fb));
        if(error){
          $("#msg-persona").textContent = "Error: "+error.message;
          return;
        }
      }

      document.querySelectorAll("#sec-persona input").forEach(i=>i.value="");
      flashSaved("#msg-persona");

      await fetchAll(); render(); syncHeaderToTable();
    }

    async function saveBien(){
      const payload = {
        nombre : $("#b-nombre").value.trim(),
        empresa: $("#b-empresa").value.trim(),
        ruc    : $("#b-ruc").value.trim(),
        celular: $("#b-celular").value.trim(),
        provee : $("#b-provee").value.trim(),
        user_id: user?.id || null,
      };

      const hasContent = Object.entries(payload)
        .some(([k,v]) => k!=="user_id" && String(v||"").trim().length>0);
      if(!hasContent){
        $("#msg-bien").classList.remove("ok");
        $("#msg-bien").textContent = "Digite alg√∫n campo para poder guardar.";
        return;
      }

      $("#msg-bien").textContent = "Guardando...";
      const { error } = await supabase.from(T_BIENES).insert(payload);
      if(error){ $("#msg-bien").textContent = "Error: "+error.message; return; }

      document.querySelectorAll("#sec-bien input").forEach(i=>i.value="");
      flashSaved("#msg-bien");
      await fetchAll(); render(); syncHeaderToTable();
    }

    async function saveServ(){
      const payload = {
        nombre : $("#s-nombre").value.trim(),
        empresa: $("#s-empresa").value.trim(),
        ruc    : $("#s-ruc").value.trim(),
        celular: $("#s-celular").value.trim(),
        servicio: $("#s-servicio").value.trim(),
        user_id: user?.id || null,
      };

      const hasContent = Object.entries(payload)
        .some(([k,v]) => k!=="user_id" && String(v||"").trim().length>0);
      if(!hasContent){
        $("#msg-serv").classList.remove("ok");
        $("#msg-serv").textContent = "Digite alg√∫n campo para poder guardar.";
        return;
      }

      $("#msg-serv").textContent = "Guardando...";
      const { error } = await supabase.from(T_SERVICIOS).insert(payload);
      if(error){ $("#msg-serv").textContent = "Error: "+error.message; return; }

      document.querySelectorAll("#sec-serv input").forEach(i=>i.value="");
      flashSaved("#msg-serv");
      await fetchAll(); render(); syncHeaderToTable();
    }

    /* ======= SAVE: INVENTARIO (NUEVO) ======= */
    async function saveInv(){
      const cantidad = parseFloat($("#i-cantidad").value);
      const precio   = parseFloat($("#i-precio_ref").value);

      const payload = {
        producto  : $("#i-producto").value.trim(),
        marca     : $("#i-marca").value.trim(),
        cantidad  : isNaN(cantidad)? null : cantidad,
        precio_ref: isNaN(precio)?   null : precio,
        user_id   : user?.id || null,
      };

      const hasContent = Object.entries(payload)
        .some(([k,v]) => k!=="user_id" && v!==null && String(v||"").trim().length>0);
      if(!hasContent){
        $("#msg-inv").classList.remove("ok");
        $("#msg-inv").textContent = "Digite alg√∫n campo para poder guardar.";
        return;
      }

      $("#msg-inv").textContent = "Guardando...";
      const { error } = await supabase.from(T_INVENTARIO).insert(payload);
      if(error){ $("#msg-inv").textContent = "Error: "+error.message; return; }

      document.querySelectorAll("#sec-inv input").forEach(i=>i.value="");
      flashSaved("#msg-inv");
      await fetchAll(); render(); syncHeaderToTable();
    }

    $("#save-persona").addEventListener("click", savePersona);
    $("#save-bien").addEventListener("click", saveBien);
    $("#save-serv").addEventListener("click", saveServ);
    $("#save-inv").addEventListener("click", saveInv);

    $("#sec-persona").addEventListener("keydown", (e)=>{ if(e.key==="Enter"){ e.preventDefault(); savePersona(); }});
    $("#sec-bien").addEventListener("keydown",    (e)=>{ if(e.key==="Enter"){ e.preventDefault(); saveBien(); }});
    $("#sec-serv").addEventListener("keydown",    (e)=>{ if(e.key==="Enter"){ e.preventDefault(); saveServ(); }});
    $("#sec-inv").addEventListener("keydown",     (e)=>{ if(e.key==="Enter"){ e.preventDefault(); saveInv(); }});

    // Data
    async function fetchAll(){
      let { data: personas } = await supabase.from(T_PERSONAS).select("*").order("created_at",{ascending:false});
      cache.personas = personas || [];
      let { data: bienes } = await supabase.from(T_BIENES).select("*").order("created_at",{ascending:false});
      cache.bienes = bienes || [];
      let { data: servicios } = await supabase.from(T_SERVICIOS).select("*").order("created_at",{ascending:false});
      cache.servicios = servicios || [];
      let { data: inventario } = await supabase.from(T_INVENTARIO).select("*").order("created_at",{ascending:false});
      cache.inventario = inventario || [];
    }

    function matchesSearch(row, fields){
      if(!searchTerm) return true;
      const t = searchTerm.toLowerCase();
      for(const f of fields){
        const val = (row[f]||"").toString().toLowerCase();
        if(val.includes(t)) return true;
      }
      return false;
    }

    function tableWrap(innerHTML, titleText=""){
      const title = titleText ? `<div class="col-title list-title">${esc(titleText)}</div>` : "";
      return `<div class="list-section">${title}<div class="table-wrap">${innerHTML}</div></div>`;
    }

    function tablePersonas(rows){
      if(!rows.length) return '<div class="empty">Sin registros.</div>';

      const cols = [
        ["categoria","Categor√≠a"],
        ["nombres","Nombres"],
        ["apellidos","Apellidos"],
        ["dni","DNI"],
        ["celular","Celular"],
        ["ruc","R.U.C."],
        ["direccion","Direcci√≥n"],
        ["tipo_cuenta","Tipo de Cuenta"],
        ["numero_cuenta","N√∫mero de Cuenta"],
        ["cci","C.C.I."],
        ["banco","Nombre del Banco"],
        ["correo","Correo"]
      ];

      let html = '<table><thead><tr>'+ cols.map(([,label])=>`<th>${label}</th>`).join('') + '</tr></thead><tbody>';

      html += rows.map(r=>{
        return `
          <tr data-type="personas" data-id="${r.id}">
            <td class="cell" data-field="categoria">${esc(r.categoria||"")}</td>
            <td class="cell" data-field="nombres">${esc(r.nombres||"")}</td>
            <td class="cell" data-field="apellidos">${esc(r.apellidos||"")}</td>
            <td class="cell" data-field="dni">${esc(r.dni||"")}</td>
            <td class="cell" data-field="celular">${esc(r.celular||"")}</td>
            <td class="cell" data-field="ruc">${esc(r.ruc||"")}</td>
            <td class="cell" data-field="direccion">${esc(r.direccion||"")}</td>
            <td class="cell" data-field="tipo_cuenta">${esc(r.tipo_cuenta||"")}</td>
            <td class="cell" data-field="numero_cuenta">${esc(r.numero_cuenta||r.cuenta||"")}</td>
            <td class="cell" data-field="cci">${esc(r.cci||"")}</td>
            <td class="cell" data-field="banco">${esc(r.banco||"")}</td>
            <td class="cell" data-field="correo">${esc(r.correo||"")}</td>
          </tr>`;
      }).join('');

      html += '</tbody></table>';
      return html;
    }

    function tableBienes(rows){
      if(!rows.length) return '<div class="empty">Sin registros.</div>';
      let html = '<table><thead><tr>'+
        '<th>Nombre del Proveedor</th><th>Empresa</th><th>R.U.C</th><th>Celular</th><th>¬øQu√© bien provee?</th>'+
      '</tr></thead><tbody>';
      html += rows.map(r=>`
        <tr data-type="bienes" data-id="${r.id}">
          <td class="cell" data-field="nombre">${esc(r.nombre||"")}</td>
          <td class="cell" data-field="empresa">${esc(r.empresa||"")}</td>
          <td class="cell" data-field="ruc">${esc(r.ruc||"")}</td>
          <td class="cell" data-field="celular">${esc(r.celular||"")}</td>
          <td class="cell" data-field="provee">${esc(r.provee||"")}</td>
        </tr>`).join('');
      html += '</tbody></table>';
      return html;
    }

    function tableServicios(rows){
      if(!rows.length) return '<div class="empty">Sin registros.</div>';
      let html = '<table><thead><tr>'+
        '<th>Nombre del Proveedor</th><th>Empresa</th><th>R.U.C</th><th>Celular</th><th>¬øQu√© servicio provee?</th>'+
      '</tr></thead><tbody>';
      html += rows.map(r=>`
        <tr data-type="servicios" data-id="${r.id}">
          <td class="cell" data-field="nombre">${esc(r.nombre||"")}</td>
          <td class="cell" data-field="empresa">${esc(r.empresa||"")}</td>
          <td class="cell" data-field="ruc">${esc(r.ruc||"")}</td>
          <td class="cell" data-field="celular">${esc(r.celular||"")}</td>
          <td class="cell" data-field="servicio">${esc(r.servicio||"")}</td>
        </tr>`).join('');
      html += '</tbody></table>';
      return html;
    }

    // ==== Helpers de moneda PEN
    const PEN = new Intl.NumberFormat('es-PE',{style:'currency',currency:'PEN',minimumFractionDigits:2});
    const fmtPEN = v => PEN.format(isFinite(v)? v : 0);

    function tableInventario(rows){
      if(!rows.length) return '<div class="empty">Sin registros.</div>';

      let totalGeneral = 0;

      let html = '<table><thead><tr>'
        + '<th>Producto</th><th>Marca</th><th>Cantidad</th><th>Precio Referencial (S/)</th><th>Total (S/)</th>'
        + '</tr></thead><tbody>';

      html += rows.map(r=>{
        const cant = Number(r.cantidad) || 0;
        const prec = Number(r.precio_ref) || 0;
        const tot  = cant * prec;
        totalGeneral += tot;
        return `
          <tr data-type="inventario" data-id="${r.id}">
            <td class="cell" data-field="producto">${esc(r.producto||"")}</td>
            <td class="cell" data-field="marca">${esc(r.marca||"")}</td>
            <td class="cell" data-field="cantidad">${esc(cant)}</td>
            <td class="cell" data-field="precio_ref">${esc(fmtPEN(prec))}</td>
            <td class="cell" data-field="__total">${esc(fmtPEN(tot))}</td>
          </tr>`;
      }).join('');

      html += '</tbody>'
          +  `<tfoot>
                <tr class="row-total">
                  <td class="tot-label" colspan="4">Total General</td>
                  <td class="tot-valor">${esc(fmtPEN(totalGeneral))}</td>
                </tr>
              </tfoot>`
          +  '</table>';

      return html;
    }

    function render(){
      // 1) üîí Guarda el scroll actual de CADA listado
      const scrollState = getScrollState();

      hideActions();

      // ¬øEstamos en TODO sin t√©rmino de b√∫squeda?
      const onTodoNoSearch = (activeTab === "todo") && (String(searchTerm || "").trim() === "");

      // Mostrar/ocultar TODO el encabezado (t√≠tulo + toolbar)
      const header = document.getElementById("listHeader");
      if (header) header.style.display = onTodoNoSearch ? "none" : "block";

      // T√≠tulo (mismo estilo que "Formulario")
      const listTitleEl = document.getElementById("list-title");
      if (listTitleEl){
        listTitleEl.textContent = onTodoNoSearch ? "" :
          (activeTab==="todo"      ? "Resultados" :
          activeTab==="personas"  ? "Listado: Personal" :
          activeTab==="bienes"    ? "Listado: Bienes" :
          activeTab==="servicios" ? "Listado: Servicios" :
                                    "Listado: Inventario");
      }

      const personas = cache.personas.filter(r => matchesSearch(r, [
        "categoria","nombres","apellidos","dni","celular","ruc","direccion",
        "tipo_cuenta","numero_cuenta","cci","banco","correo","cuenta"
      ]));
      const bienes   = cache.bienes.filter(r   => matchesSearch(r, ["nombre","empresa","ruc","celular","provee"]));
      const servs    = cache.servicios.filter(r=> matchesSearch(r, ["nombre","empresa","ruc","celular","servicio"]));
      const invs     = cache.inventario.filter(r=> matchesSearch(r, ["producto","marca","cantidad","precio_ref"]));

      const showTitles = (activeTab === "todo");

      // 2) üîÅ Repinta las tablas
      $("#list-personas").innerHTML   = tableWrap(tablePersonas(personas),   showTitles ? "Personal"   : "");
      $("#list-bienes").innerHTML     = tableWrap(tableBienes(bienes),       showTitles ? "Bienes"     : "");
      $("#list-servicios").innerHTML  = tableWrap(tableServicios(servs),     showTitles ? "Servicios"  : "");
      $("#list-inventario").innerHTML = tableWrap(tableInventario(invs),     showTitles ? "Inventario" : "");

      // 3) üîô Restaura los scrolls (evita que salte al inicio)
      restoreScrollState(scrollState);

      const re = $("#right-empty");
      if (re) re.style.display = onTodoNoSearch ? "block" : "none";

      $("#list-personas").style.display   = onTodoNoSearch ? "none" : ((activeTab==="todo" || activeTab==="personas")  ? "block" : "none");
      $("#list-bienes").style.display     = onTodoNoSearch ? "none" : ((activeTab==="todo" || activeTab==="bienes")    ? "block" : "none");
      $("#list-servicios").style.display  = onTodoNoSearch ? "none" : ((activeTab==="todo" || activeTab==="servicios") ? "block" : "none");
      $("#list-inventario").style.display = onTodoNoSearch ? "none" : ((activeTab==="todo" || activeTab==="inventario")? "block" : "none");

      // 4) Reajustes visuales
      syncHeaderToTable();
      enforceScrollLimit();
    }

    function esc(s){
      return (s==null ? "" : String(s)).replace(/[&<>"']/g, c => (
        {"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c]
      ));
    }

    function escAttr(s){ return (s==null ? "" : String(s)).replace(/"/g,'&quot;'); }

    // B√∫squeda
    function clearSearch(){
      searchTerm = "";
      const qi = $("#q");
      if(qi){ qi.value=""; }
      render(); syncHeaderToTable();

      const qc = $("#q-clear");
      if(qc){ qc.style.display = "none"; }
    }

    const q      = $("#q");
    const qClear = $("#q-clear");

    // Enfocar y seleccionar el buscador
    function focusSearch(){
      const qi = $("#q");
      if(qi){
        qi.focus({ preventScroll:true });
        qi.select();
      }
    }

    // Click/teclado sobre el panel vac√≠o de la derecha
    $("#right-empty")?.addEventListener("click", focusSearch);
    $("#right-empty")?.addEventListener("keydown", (e)=>{
      if(e.key==="Enter" || e.key===" "){ e.preventDefault(); focusSearch(); }
    });

    function syncClearBtn(){
      if(!qClear || !q) return;
      qClear.style.display = q.value.trim() ? "inline-flex" : "none";
    }

    q?.addEventListener("input", (e)=>{
      searchTerm = e.target.value;
      render();
      syncClearBtn();
    });

    q?.addEventListener("keydown", (e)=>{
      if(e.key==="Escape"){
        e.preventDefault();
        e.stopPropagation();         // ‚Üê no dejes que suba al global
        handleEscape(e);             // ‚Üê ahora sigue las etapas
      }
    });

    q?.addEventListener("search", (e)=>{
      searchTerm = e.target.value;
      render();
      syncClearBtn();
    });

    qClear?.addEventListener("click", ()=>{
      clearSearch();
    });

    // Export
    $("#btnExport").addEventListener("click", ()=>{
      let rows = [];
      if(activeTab==="personas"){
        rows = cache.personas.filter(r=>matchesSearch(r,[
          "categoria","nombres","apellidos","dni","celular","ruc","direccion",
          "tipo_cuenta","numero_cuenta","cci","banco","correo","cuenta"
        ]));
      } else if(activeTab==="bienes"){
        rows = cache.bienes.filter(r=>matchesSearch(r,["nombre","empresa","ruc","celular","provee"]));
      } else if(activeTab==="servicios"){
        rows = cache.servicios.filter(r=>matchesSearch(r,["nombre","empresa","ruc","celular","servicio"]));
      } else if(activeTab==="inventario"){
        rows = cache.inventario.filter(r=>matchesSearch(r,["producto","marca","cantidad","precio_ref"]));
      } else {
        rows = [
          ...cache.personas.map(r=>({tipo:"personal", ...r})),
          ...cache.bienes  .map(r=>({tipo:"bien",     ...r})),
          ...cache.servicios.map(r=>({tipo:"servicio", ...r})),
          ...cache.inventario.map(r=>({tipo:"inventario", ...r})),
        ];
      }
      const csv = toCSV(rows);
      const blob = new Blob([csv], {type:"text/csv;charset=utf-8;"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = `export_${activeTab}.csv`; a.click();
      URL.revokeObjectURL(url);
    });

    function toCSV(rows){
      if(!rows.length) return "";
      const headers = Array.from(new Set(rows.flatMap(r=>Object.keys(r)))).filter(k=>!["id","user_id"].includes(k));
      const escF = v => `"${(v==null?"":String(v)).replace(/"/g,'""')}"`;
      let out = headers.join(",") + "\n";
      for(const r of rows){ out += headers.map(h=>escF(r[h]??"")).join(",") + "\n"; }
      return out;
    }

    // Acciones cabecera + selecci√≥n
    const hdrActions = document.getElementById('hdr-actions');

    // üîí Helper: devuelve la fila que est√° en edici√≥n (si existe)
    function getEditingRow(){
      return document.querySelector('#lists tr[data-editing="1"]');
    }

    function actionsViewHTML(){
      return `
        <button class="act-btn tb-edit" title="Editar"><span class="material-symbols-outlined">stylus_note</span></button>
        <button class="act-btn tb-del"  title="Eliminar"><span class="material-symbols-outlined">delete</span></button>`;
    }
    function actionsEditHTML(){
      return `
        <button class="act-btn tb-save" title="Guardar"><span class="material-symbols-outlined">done</span></button>
        <button class="act-btn tb-cancel" title="Cancelar"><span class="material-symbols-outlined">close</span></button>`;
    }

    function setActionsMode(mode){
      hdrActions.innerHTML = (mode==='edit'? actionsEditHTML() : actionsViewHTML());
      // Recalcula m√°rgenes del header contra la tabla y asegura centrado correcto
      syncHeaderToTable();
    }

    function hideActions(){
      hdrActions.classList.remove('show');
      hdrActions.dataset.targetId='';
      hdrActions.dataset.targetType='';
      hdrActions.innerHTML = actionsViewHTML();
      // Ajuste por si cambi√≥ el ancho disponible
      syncHeaderToTable();
    }

    function getSelectedRows(){ return $$("#lists tr.selected"); }
    function getSelectedIdsByType(){
      const map = { personas:[], bienes:[], servicios:[], inventario:[] };
      getSelectedRows().forEach(tr => map[tr.dataset.type].push(tr.dataset.id));
      return map;
    }

    function updateActionToolbar(){
      // üîí Si hay una fila en edici√≥n, forzamos el modo edici√≥n (‚úî / ‚úñ)
      const editing = getEditingRow();
      if (editing){
        setActionsMode('edit');
        hdrActions.dataset.targetId   = editing.dataset.id   || '';
        hdrActions.dataset.targetType = editing.dataset.type || '';
        hdrActions.classList.add('show');
        return; // no dejamos que vuelva a l√°piz/basura
      }

      const selected = getSelectedRows();
      if(selected.length===0){ hideActions(); return; }

      if(selected.length===1){
        setActionsMode('view');
        hdrActions.dataset.targetId   = selected[0].dataset.id || '';
        hdrActions.dataset.targetType = selected[0].dataset.type || '';
      }else{
        hdrActions.innerHTML = `<button class="act-btn tb-del" title="Eliminar selecci√≥n"><span class="material-symbols-outlined">delete</span></button>`;
        hdrActions.dataset.targetId   = selected.map(r=>r.dataset.id).join(',');
        hdrActions.dataset.targetType = [...new Set(selected.map(r=>r.dataset.type))].join(',');
      }
      hdrActions.classList.add('show');
    }

    // selecci√≥n instant√°nea (CTRL/SHIFT) con bloqueo cuando hay edici√≥n activa
    document.getElementById("lists").addEventListener("pointerdown", (e) => {
      // Si clickeas dentro del input en edici√≥n, no tocamos nada
      if (e.target.closest(".edit-input")) return;

      const tr = e.target.closest("tr");
      if (!tr) return;

      // üîí Bloqueo duro: si hay una fila en edici√≥n, NO permitimos cambiar selecci√≥n
      const editing = getEditingRow();
      if (editing && tr !== editing){
        // Reforzamos el foco dentro de la edici√≥n y mantenemos ‚úî / ‚úñ
        const first = editing.querySelector('.edit-input');
        if (first) first.focus({ preventScroll:true });

        setActionsMode('edit');
        hdrActions.dataset.targetId   = editing.dataset.id   || '';
        hdrActions.dataset.targetType = editing.dataset.type || '';
        hdrActions.classList.add('show');

        e.preventDefault();
        return; // salimos: no cambia la selecci√≥n
      }

      // No seleccionar filas de totales ni filas sin dataset usable
      if (tr.closest("tfoot") || !tr.dataset || !tr.dataset.type || !tr.dataset.id) {
        return;
      }

      const isShift = e.shiftKey;
      const isCtrl  = e.ctrlKey || e.metaKey; // meta para compatibilidad Mac

      if (isShift) {
        let anchor = lastAnchorRow;
        if (!anchor || !sameGroup(anchor, tr)) {
          anchor = getGroupRows(tr).find(r => r.classList.contains("selected")) || tr;
        }
        selectRangeBetween(anchor, tr, /*append=*/isCtrl);
        lastAnchorRow = tr;
      } else if (isCtrl) {
        tr.classList.toggle("selected");
        lastAnchorRow = tr;
      } else {
        clearAllSelection();
        tr.classList.add("selected");
        lastAnchorRow = tr;
      }

      updateActionToolbar();
    }, { passive: true });

    /* ===== Helpers selecci√≥n de filas (Shift/Ctrl) ===== */
    function sameGroup(a, b){
      return a?.closest('tbody') === b?.closest('tbody');
    }

    function getGroupRows(tr){
      const tbody = tr?.closest('tbody');
      return tbody ? Array.from(tbody.querySelectorAll('tr[data-id]')) : [];
    }

    function clearAllSelection(){
      $$("#lists tr.selected").forEach(x=>x.classList.remove("selected"));
    }

    function selectRangeBetween(anchor, target, append=false){
      const rows = getGroupRows(target);
      if(!rows.length){
        return;
      }

      // Si no hay ancla o no es del mismo grupo/tabla, hacemos selecci√≥n simple
      if(!anchor || !sameGroup(anchor, target)){
        if(!append) clearAllSelection();
        target.classList.add("selected");
        return;
      }

      const ia = rows.indexOf(anchor);
      const ib = rows.indexOf(target);

      if(ia === -1 || ib === -1){
        if(!append) clearAllSelection();
        target.classList.add("selected");
        return;
      }

      const [start, end] = ia <= ib ? [ia, ib] : [ib, ia];
      if(!append) clearAllSelection();
      for(let i = start; i <= end; i++){
        rows[i].classList.add("selected");
      }
    }

    // acciones de toolbar
    document.addEventListener('click', async (e)=>{
      const btn = e.target.closest('.tb-edit,.tb-del,.tb-save,.tb-cancel');
      if(!btn) return;

      const selected = getSelectedRows();

      if(btn.classList.contains('tb-del') && selected.length>1){
        const total = selected.length;
        const ok = await uiConfirm(`¬øBorrar ${total} registro${total>1?'s':''}?`, "Confirmaci√≥n");
        if(!ok) return;
        const byType = getSelectedIdsByType();
        await doDeleteBulk(byType);
        return;
      }

      const id = hdrActions.dataset.targetId;
      const type = hdrActions.dataset.targetType;
      if(!id || !type) return;

      const tr = document.querySelector(`#lists tbody tr[data-type="${type}"][data-id="${id}"]`);
      if(!tr) return;

      if(btn.classList.contains('tb-edit')){
        enterEdit(tr, type, id);
        setActionsMode('edit');
      }else if(btn.classList.contains('tb-del')){
        await doDelete(type, id);
        hideActions();
      }else if(btn.classList.contains('tb-save')){
        await doSave(tr, type, id);
        await fetchAll(); render();
        reselectRow(type, id);
      }else if(btn.classList.contains('tb-cancel')){
        render();
        reselectRow(type, id);
      }
    });

    function reselectRow(type, id){
      const row = document.querySelector(`#lists tr[data-type="${type}"][data-id="${id}"]`);
      if(!row) { hideActions(); return; }
      $$("#lists tr.selected").forEach(x=>x.classList.remove("selected"));
      row.classList.add('selected');
      hdrActions.dataset.targetId = id;
      hdrActions.dataset.targetType = type;
      setActionsMode('view');
      hdrActions.classList.add('show');
    }

    function enterEdit(tr, type, id){
      const cfg = TABLES[type]; if(!cfg) return;

      // üî∏ Solo una fila puede quedar marcada como "en edici√≥n"
      $$('#lists tr[data-editing="1"]').forEach(r => r.removeAttribute('data-editing'));

      // üî∏ Marca esta fila como editando y aseg√∫rala como seleccionada
      tr.dataset.editing = "1";
      tr.classList.add('selected');
      lastAnchorRow = tr; // ancla de rango en la fila editada

      // üîí Fijamos la toolbar en modo edici√≥n (‚úî / ‚úñ) y apuntando a esta fila
      hdrActions.dataset.targetId   = id;
      hdrActions.dataset.targetType = type;
      setActionsMode('edit');
      hdrActions.classList.add('show');

      const inputs = [];

      cfg.cols.forEach((field)=>{
        const td = tr.querySelector(`td[data-field="${field}"]`);
        if(!td) return;

        const currentText = td.textContent;
        const current = (type==="inventario" && field==="precio_ref")
          ? (String(currentText).replace(/[^\d.,-]/g,"").replace(",",".")) 
          : currentText;

        td.innerHTML = `
          <span class="cell-ghost">${esc(currentText)}</span>
          <input class="edit-input" data-field="${field}" value="${escAttr(current)}" />
        `;
        inputs.push(td.querySelector('.edit-input'));
      });

      inputs.forEach(inp=>{
        inp.addEventListener("keydown", async (ev)=>{
          if (ev.key === "Enter"){
            ev.preventDefault();
            ev.stopPropagation();                 // ‚Üê NO dejar que suba
            await doSave(tr, type, id);
            await fetchAll(); render(); reselectRow(type,id);
          }
          if (ev.key === "Escape"){
            ev.preventDefault();
            ev.stopPropagation();                 // ‚Üê NO dejar que suba
            render(); reselectRow(type,id);       // cancela edici√≥n, mantiene selecci√≥n
          }
        });
      });

      inputs[0]?.focus({ preventScroll:true });
    }

    async function doSave(tr, type, id){
      const cfg = TABLES[type]; if(!cfg) return;
      const payload = {};
      cfg.cols.forEach((field)=>{
        let val = tr.querySelector(`input[data-field="${field}"]`)?.value ?? "";
        if(type==="inventario"){
          if(field==="cantidad"){ val = parseFloat(val); if(isNaN(val)) val = null; }
          if(field==="precio_ref"){
            val = parseFloat(String(val).replace(",","."));
            if(isNaN(val)) val = null;
          }
        }
        payload[field] = (val==null) ? null : String(val).trim();
      });

      if(type==="inventario"){
        if(payload.cantidad!==null) payload.cantidad = Number(payload.cantidad);
        if(payload.precio_ref!==null) payload.precio_ref = Number(payload.precio_ref);
      }

      let { error } = await supabase.from(cfg.table).update(payload).eq("id", id);
      if(error && type==="personas"){
        const fb = {
          nombres  : [payload.nombres||"", payload.apellidos||""].filter(Boolean).join(" ").trim(),
          dni      : payload.dni || "",
          celular  : payload.celular || "",
          ruc      : payload.ruc || "",
          direccion: payload.direccion || "",
          cuenta   : payload.numero_cuenta || "",
          banco    : payload.banco || ""
        };
        ({ error } = await supabase.from(cfg.table).update(fb).eq("id", id));
        if(error){ await uiAlert("Error al guardar: " + error.message, "Error"); return; }
      }else if(error){
        await uiAlert("Error al guardar: " + error.message, "Error"); return;
      }
    }

    async function doDelete(type, id){
      const cfg = TABLES[type]; if(!cfg) return;
      const ok = await uiConfirm("¬øBorrar este registro?", "Confirmaci√≥n");
      if(!ok) return;

      const { error } = await supabase.from(cfg.table).delete().eq("id", id);
      if(error){ await uiAlert("Error al borrar: " + error.message, "Error"); return; }

      await fetchAll(); render();
      hideActions();
    }

    async function doDeleteBulk(byType){
      for (const [type, ids] of Object.entries(byType)) {
        if (!ids.length) continue;
        const cfg = TABLES[type];
        if (!cfg) continue;

        const { error } = await supabase
          .from(cfg.table)
          .delete()
          .in('id', ids);

        if (error) {
          alert(`Error al borrar ${type}: ${error.message}`);
          return;
        }
      }
      await fetchAll();
      render();
      hideActions();
    }

    // Escape por ETAPAS (sin ‚Äúresetear‚Äù todo de golpe)
    function handleEscape(e){
      // 1) Si hay una fila en edici√≥n ‚Üí cancelar edici√≥n (mantener selecci√≥n)
      const editing = getEditingRow?.();
      if (editing){
        const type = editing.dataset.type;
        const id   = editing.dataset.id;
        render();
        reselectRow(type, id);      // vuelve a dejarla seleccionada
        return true;
      }

      // 2) Si hay selecci√≥n ‚Üí solo limpiar la selecci√≥n
      const selected = getSelectedRows?.() || [];
      if (selected.length){
        clearAllSelection();
        lastAnchorRow = null;
        hideActions();
        return true;
      }

      // 3) Si hay texto en el buscador ‚Üí limpiar buscador (sin cambiar pesta√±a)
      const qi = document.getElementById("q");
      if (qi && qi.value.trim()){
        clearSearch();
        return true;
      }

      // 4) Si hay un formulario abierto a la izquierda ‚Üí ocultarlo (no borro lo escrito)
      const openForm = ["persona","bien","serv","inv"]
        .map(id => document.getElementById("sec-"+id))
        .find(sec => sec && sec.style.display !== "none");
      if (openForm){
        openForm.style.display = "none";
        updateLeftEmpty?.();
        return true;
      }

      // 5) Si no hay nada que hacer ‚Üí opcional: quitar foco para sacar halos
      const ae = document.activeElement;
      if (ae && typeof ae.blur === "function"){ ae.blur(); }
      return false;
    }

    // Listener global ‚Üí usa las ETAPAS
    document.addEventListener("keydown",(e)=>{
      if(e.key === "Escape"){
        e.preventDefault();
        handleEscape(e);
      }
    });

    // Go!
    async function boot(){ await init(); enforceScrollLimit(); }
    boot();
  </script>
</body>
</html>
